import{_ as p}from"./ValaxyMain.vue_vue_type_style_index_0_lang-DRVqeRiY.js";import{a as d,p as r,o as c,c as y,w as e,f as E,r as t,g as s,h as i}from"./app-CzjF7NIc.js";import"./YunFooter.vue_vue_type_script_setup_true_lang-17i98rOK.js";import"./YunCard.vue_vue_type_script_setup_true_lang-Da3dkqK-.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang-BsneHNVS.js";import"./index-C7yU5XnD.js";const g=s("h1",{id:"什么是celery",tabindex:"-1"},[i("什么是celery "),s("a",{class:"header-anchor",href:"#什么是celery","aria-label":'Permalink to "什么是celery"'},"​")],-1),u=s("pre",null,[s("code",null,` Celery 是一个异步任务队列。你可以使用它在你的应用上下文之外执行任务。总的想法就是你的应用程序可能需要执行任何消耗资源的任务都可以交给任务队列，让你的应用程序自由和快速地响应客户端请求。
`)],-1),m=s("h1",{id:"我的尝试",tabindex:"-1"},[i("我的尝试 "),s("a",{class:"header-anchor",href:"#我的尝试","aria-label":'Permalink to "我的尝试"'},"​")],-1),_=s("p",null,"最近写异步爬虫想在Flask中应用，找了很多方法，包括流式渲染。后来又接触了celery。celery在很多方面都会用到，flask也不例外。 在这里我用celery的意图是用celery在后台运行任务",-1),f=s("h2",{id:"celery配置",tabindex:"-1"},[i("celery配置 "),s("a",{class:"header-anchor",href:"#celery配置","aria-label":'Permalink to "celery配置"'},"​")],-1),F=s("p",null,[i("首先在"),s("code",null,"__init__"),i("中初始化celery，选择broker")],-1),b=s("div",{class:"language-python vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"python"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"app "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Flask("),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"__name__"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"app.config.from_object(celeryconfig)")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"celery "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Celery(app.name)")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"celery.config_from_object(celeryconfig)")])])]),s("button",{class:"collapse"})],-1),v=s("p",null,"我在celeryconfig.py中设置了broker相关的配置，并在init中加载（redis的安装和部署在这里就不写了）",-1),C=s("div",{class:"language-python vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"python"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"CELERY_BROKER_URL"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'redis://localhost:6379/0'")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"CELERY_RESULT_BACKEND"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'redis://localhost:6379/0'")])])]),s("button",{class:"collapse"})],-1),w=s("h2",{id:"任务定义及执行方法",tabindex:"-1"},[i("任务定义及执行方法 "),s("a",{class:"header-anchor",href:"#任务定义及执行方法","aria-label":'Permalink to "任务定义及执行方法"'},"​")],-1),B=s("p",null,"然后定义一个celery任务",-1),A=s("div",{class:"language-python vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"python"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"@celery.task"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"def"),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," get_topics"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(group_links):")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    with"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," app.app_context():")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        topics "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," worker(group_links)")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," topics")])])]),s("button",{class:"collapse"})],-1),D=s("p",null,[i("调取任务，其中"),s("code",null,"delay"),i("方法相当于"),s("code",null,"apply_async"),i("的一种简写方式。如果要用到更多的参数，则需调用"),s("code",null,"apply_async")],-1),$=s("div",{class:"language-python vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"python"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"@app.route"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'/api/group/<groupid>'"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),s("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"methods"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"["),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'POST'"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'GET'"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"])")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"def"),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," test_api"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(groupid):")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    base_url "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'https://www.douban.com/group/"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"{}"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/'")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    links "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," [ base_url.format(i) "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"for"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"in"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," eval"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(groupid) ]")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," get_topics.delay(links)")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," jsonify(result.get())")])])]),s("button",{class:"collapse"})],-1),T=s("h2",{id:"启动redis并用cmd执行celery",tabindex:"-1"},[i("启动redis并用cmd执行celery "),s("a",{class:"header-anchor",href:"#启动redis并用cmd执行celery","aria-label":'Permalink to "启动redis并用cmd执行celery"'},"​")],-1),P=s("p",null,"1.启动redis（此处省略） 2.启动celery",-1),z=s("div",{class:"language-python vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"python"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"celery worker "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"A app.celery "),s("span",{style:{"--shiki-light":"#B31D28","--shiki-dark":"#FDAEB7","--shiki-light-font-style":"italic","--shiki-dark-font-style":"italic"}},"--"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"loglevel"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"info")])])]),s("button",{class:"collapse"})],-1),R=s("h1",{id:"失败原因",tabindex:"-1"},[i("失败原因 "),s("a",{class:"header-anchor",href:"#失败原因","aria-label":'Permalink to "失败原因"'},"​")],-1),j=s("p",null,[i("运行报错，查了半天发现了一篇文章("),s("a",{href:"https://blog.csdn.net/javali1995/article/details/78475108",target:"_blank",rel:"noreferrer"},"https://blog.csdn.net/javali1995/article/details/78475108"),i(")")],-1),x=s("blockquote",null,[s("p",null,"celery4 不支持windows！celery4 不支持windows！celery4 不支持windows！ celery 3.1.18不支持python36！celery 3.1.18不支持python36！celery 3.1.18不支持python36！")],-1),L=s("p",null,[i("好心烦，celery尝试失败。本来以为看到了希望，对于Flask自己的知识基础还是太薄弱了 然后又找到一篇文章： "),s("a",{href:"https://zhuanlan.zhihu.com/p/30897711",target:"_blank",rel:"noreferrer"},"https://zhuanlan.zhihu.com/p/30897711"),i(" 也是说flask基本上是不支持原生async/await，唯一的解决方案只有celery了。太坑爹了而且celery真的很重。目前也没有linux服务器")],-1),q={__name:"shi-yong-celery-rang-ren-wu-zai-hou-tai-yun-xing-wei-wan",setup(N,{expose:o}){const l=JSON.parse('{"title":"使用celery让任务在后台运行（失败，celery不支持windows)","description":"","frontmatter":{"title":"使用celery让任务在后台运行（失败，celery不支持windows)","date":"2020-08-14T11:51:00.000Z","tags":[],"published":true,"hideInList":false,"feature":null,"isTop":false},"headers":[{"level":2,"title":"celery配置","slug":"celery配置","link":"#celery配置","children":[]},{"level":2,"title":"任务定义及执行方法","slug":"任务定义及执行方法","link":"#任务定义及执行方法","children":[]},{"level":2,"title":"启动redis并用cmd执行celery","slug":"启动redis并用cmd执行celery","link":"#启动redis并用cmd执行celery","children":[]}],"relativePath":"pages/posts/history/shi-yong-celery-rang-ren-wu-zai-hou-tai-yun-xing-wei-wan.md","path":"/home/runner/work/1dayluo.github.io/1dayluo.github.io/pages/posts/history/shi-yong-celery-rang-ren-wu-zai-hou-tai-yun-xing-wei-wan.md","lastUpdated":1714218709000}'),h=d(),n=l.frontmatter||{};return h.meta.frontmatter=Object.assign(h.meta.frontmatter||{},l.frontmatter||{}),r("pageData",l),r("valaxy:frontmatter",n),globalThis.$frontmatter=n,o({frontmatter:{title:"使用celery让任务在后台运行（失败，celery不支持windows)",date:"2020-08-14T11:51:00.000Z",tags:[],published:!0,hideInList:!1,feature:null,isTop:!1}}),(a,S)=>{const k=p;return c(),y(k,{frontmatter:E(n)},{"main-content-md":e(()=>[g,u,m,_,f,F,b,v,C,w,B,A,D,$,T,P,z,R,j,x,L]),"main-header":e(()=>[t(a.$slots,"main-header")]),"main-header-after":e(()=>[t(a.$slots,"main-header-after")]),"main-nav":e(()=>[t(a.$slots,"main-nav")]),"main-content":e(()=>[t(a.$slots,"main-content")]),"main-content-after":e(()=>[t(a.$slots,"main-content-after")]),"main-nav-before":e(()=>[t(a.$slots,"main-nav-before")]),"main-nav-after":e(()=>[t(a.$slots,"main-nav-after")]),comment:e(()=>[t(a.$slots,"comment")]),footer:e(()=>[t(a.$slots,"footer")]),aside:e(()=>[t(a.$slots,"aside")]),"aside-custom":e(()=>[t(a.$slots,"aside-custom")]),default:e(()=>[t(a.$slots,"default")]),_:3},8,["frontmatter"])}}};export{q as default};
