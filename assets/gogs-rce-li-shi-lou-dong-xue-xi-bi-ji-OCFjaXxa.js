import{_ as d}from"./ValaxyMain.vue_vue_type_style_index_0_lang-DRVqeRiY.js";import{a as g,p as o,o as p,c as E,w as e,f as c,r as l,g as s,h as i}from"./app-CzjF7NIc.js";import"./YunFooter.vue_vue_type_script_setup_true_lang-17i98rOK.js";import"./YunCard.vue_vue_type_script_setup_true_lang-Da3dkqK-.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang-BsneHNVS.js";import"./index-C7yU5XnD.js";const u=s("aside",null," 💡 This exercise covers how to get code execution against the Git self hosted tool: Gogs. ",-1),y=s("p",null,"备注: gogs的老漏洞学习,非最新的.靶场学习的, 里面提供了复现环境,就不用自己搭建了.",-1),m=s("h2",{id:"概括",tabindex:"-1"},[i("概括 "),s("a",{class:"header-anchor",href:"#概括","aria-label":'Permalink to "概括"'},"​")],-1),b=s("p",null,"gogs是一种提供能自己服务器上搭建git服务的开源项目,即自助git",-1),_=s("p",null,"gogs的攻击分为两步:",-1),F=s("ol",null,[s("li",null,"绕过验证变为administrator"),s("li",null,"使用hook获取命令执行rce")],-1),f=s("h2",{id:"漏洞分析学习",tabindex:"-1"},[i("漏洞分析学习 "),s("a",{class:"header-anchor",href:"#漏洞分析学习","aria-label":'Permalink to "漏洞分析学习"'},"​")],-1),v=s("p",null,"分析主要是看Reference里的文章, 大佬文章写的足够详细了, 我就简单记录一下跟着文章捋的思路和自己的一些梳理. 建议还是看原文, 有更详细的代码分析(学习时写自己的思路笔记才有助于理解不是吗)",-1),C=s("h3",{id:"修复的关键代码",tabindex:"-1"},[i("修复的关键代码: "),s("a",{class:"header-anchor",href:"#修复的关键代码","aria-label":'Permalink to "修复的关键代码:"'},"​")],-1),D=s("div",{class:"language-go vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"go"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// Read returns raw session store by session ID.")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"func"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),s("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"m "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"*"),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"Manager"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"Read"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),s("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"sid"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," string"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") ("),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"RawStore"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"error"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},'    // No slashes or dots "./" should ever occur in the sid and to prevent session file forgery bug.')]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // See https://github.com/gogs/gogs/issues/5469")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," strings."),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ContainsAny"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(sid, "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"./"'),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," nil"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", errors."),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"New"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},`"invalid 'sid': "`),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," sid)")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," m.provider."),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"Read"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(sid)")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),s("button",{class:"collapse"})],-1),A=s("p",null,"利用条件:",-1),B=s("ol",null,[s("li",null,"Gogs的配置文件指定session存储方式为文件"),s("li",null,[i("后台逻辑(session.go)没有考虑到过滤 "),s("code",null,"../"),i(" 等字符")]),s("li",null,[s("code",null,"i_like_gogits"),i(" 可以加载任意文件的内容(同2)")])],-1),N=s("p",null,"其中:",-1),w=s("ul",null,[s("li",null,[i("cookie中 "),s("code",null,"i_like_gogits"),i(" 为对应session文件的文件名, 这里可以改为管理员的session")])],-1),L=s("p",null,"而其中session的信息需要人为构造并且找到一个上传点",-1),R=s("h3",{id:"人为构造session",tabindex:"-1"},[i("人为构造session: "),s("a",{class:"header-anchor",href:"#人为构造session","aria-label":'Permalink to "人为构造session:"'},"​")],-1),$=s("p",null,[i("session生成是由 "),s("code",null,"EncodeGob"),i(" 解码则是通过 "),s("code",null,"DecodeGob"),i(" ,解码对应session然后修改里面的uid为管理员uid和uname, 再由EncodeGob编码.")],-1),G=s("ul",null,[s("li",null,"encoding session的代码")],-1),x=s("div",{class:"language-go vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"go"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"func"),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," EncodeGob"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),s("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"obj"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," map"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"["),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"interface"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{}]"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"interface"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{}) ([]"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"byte"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"error"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," _, v "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":="),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," range"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," obj {")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        gob."),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"Register"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(v)")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    buf "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":="),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," bytes."),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"NewBuffer"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"nil"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    err "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":="),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," gob."),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"NewEncoder"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(buf)."),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"Encode"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(obj)")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," buf."),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"Bytes"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), err")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),s("button",{class:"collapse"})],-1),P=s("p",null,[i("User 结构体("),s("a",{href:"https://github.com/gogs/gogs/blob/be6bb5314ee7d8ed53362d8e6893b061e5210f48/models/user.go#L50-L52",target:"_blank",rel:"noreferrer"},"https://github.com/gogs/gogs/blob/be6bb5314ee7d8ed53362d8e6893b061e5210f48/models/user.go#L50-L52"),i(")")],-1),I=s("div",{class:"language-go vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"go"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"type"),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," User"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," struct"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ID        "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int64")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    LowerName "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"string"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' `xorm:"UNIQUE NOT NULL"`')]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Name      "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"string"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' `xorm:"UNIQUE NOT NULL"`')]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    FullName  "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"string")])])]),s("button",{class:"collapse"})],-1),S=s("p",null,[i("获取session的代码("),s("a",{href:"https://github.com/gogs/gogs/blob/be6bb5314ee7d8ed53362d8e6893b061e5210f48/routes/user/auth.go#L127-L128",target:"_blank",rel:"noreferrer"},"routes/user/auth.go"),i(") 涉及到用户身份的有两个值")],-1),T=s("div",{class:"language-go vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"go"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"c.Session."),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"Set"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"uid"'),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", u.ID)")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"c.Session."),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"Set"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"uname"'),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", u.Name)")])])]),s("button",{class:"collapse"})],-1),U=s("h3",{id:"上传点",tabindex:"-1"},[i("上传点 "),s("a",{class:"header-anchor",href:"#上传点","aria-label":'Permalink to "上传点"'},"​")],-1),j=s("p",null,"Gogs提供了三种方式在服务器上传:",-1),O=s("ul",null,[s("li",null,"使用issue tracker提供的上传功能 :"),s("li",null,"用git push : 但是受限上传文件类型/内容过滤"),s("li",null,"使用upload file在给定repository"),s("li")],-1),M=s("p",null,[i("这里用upload file为例子,当你创建repo的拷贝后, Gogs会将文件放在 "),s("code",null,"/data/gogs/data/tmp/local-repo/[REPO_ID]/[FILENAME]"),i(" 里, 这里repo_id可以在fork的时候查看链接(链接里子目录名), 对应"),s("a",{href:"https://github.com/gogs/gogs/blob/be6bb5314ee7d8ed53362d8e6893b061e5210f48/models/repo.go#L594-L596",target:"_blank",rel:"noreferrer"},"代码"),i(". 这里session默认存储路径为 "),s("code",null,"/**data/gogs/data/sessions/"),i(" *")],-1),V=s("p",null,[i("构造即在"),s("code",null,"i_like_gogits"),i(" 中将文件指向相对路径即可")],-1),q=s("figure",null,[s("img",{src:"https://i.imgur.com/H7FyjSv.png",alt:"",loading:"lazy",decoding:"async"})],-1),Q=s("h3",{id:"登录后利用",tabindex:"-1"},[i("登录后利用 "),s("a",{class:"header-anchor",href:"#登录后利用","aria-label":'Permalink to "登录后利用"'},"​")],-1),Z=s("p",null,"用的git的hook功能. 实现RCE",-1),z=s("p",null,[i("git hook以前刷题用到过,见 "),s("a",{href:"https://1dayluo.github.io/post/htbencoding/#git-commitsh",target:"_blank",rel:"noreferrer"},"https://1dayluo.github.io/post/htbencoding/#git-commitsh"),i(" 这里注意看仓库设置里Gogs支持的hook, 我在复现的时候就发现了靶场不支持post-commit的hook")],-1),H=s("h2",{id:"反思",tabindex:"-1"},[i("反思 "),s("a",{class:"header-anchor",href:"#反思","aria-label":'Permalink to "反思"'},"​")],-1),J=s("p",null,"这个漏洞是经典的session管理和文件目录遍历结合的洞, 学习组合拳什么的…包括代码审计遇到类似的也可以(gogs的session管理和php的session管理是一样的机制)",-1),K=s("h2",{id:"reference",tabindex:"-1"},[i("Reference "),s("a",{class:"header-anchor",href:"#reference","aria-label":'Permalink to "Reference"'},"​")],-1),W=s("ul",null,[s("li",null,[s("a",{href:"https://www.anquanke.com/post/id/163575",target:"_blank",rel:"noreferrer"},"https://www.anquanke.com/post/id/163575")]),s("li",null,"Pentesterlab: Green")],-1),hs={__name:"gogs-rce-li-shi-lou-dong-xue-xi-bi-ji",setup(X,{expose:r}){const a=JSON.parse('{"title":" Gogs RCE 历史漏洞学习笔记","description":"","frontmatter":{"title":" Gogs RCE 历史漏洞学习笔记","date":"2023-05-25T19:23:23.000Z","tags":["漏洞分析","笔记","靶场","刷题","学习笔记"],"published":true,"hideInList":false,"feature":null,"isTop":false},"headers":[{"level":2,"title":"概括","slug":"概括","link":"#概括","children":[]},{"level":2,"title":"漏洞分析学习","slug":"漏洞分析学习","link":"#漏洞分析学习","children":[{"level":3,"title":"修复的关键代码:","slug":"修复的关键代码","link":"#修复的关键代码","children":[]},{"level":3,"title":"人为构造session:","slug":"人为构造session","link":"#人为构造session","children":[]},{"level":3,"title":"上传点","slug":"上传点","link":"#上传点","children":[]},{"level":3,"title":"登录后利用","slug":"登录后利用","link":"#登录后利用","children":[]}]},{"level":2,"title":"反思","slug":"反思","link":"#反思","children":[]},{"level":2,"title":"Reference","slug":"reference","link":"#reference","children":[]}],"relativePath":"pages/posts/history/gogs-rce-li-shi-lou-dong-xue-xi-bi-ji.md","path":"/home/runner/work/1dayluo.github.io/1dayluo.github.io/pages/posts/history/gogs-rce-li-shi-lou-dong-xue-xi-bi-ji.md","lastUpdated":1714218709000}'),h=g(),n=a.frontmatter||{};return h.meta.frontmatter=Object.assign(h.meta.frontmatter||{},a.frontmatter||{}),o("pageData",a),o("valaxy:frontmatter",n),globalThis.$frontmatter=n,r({frontmatter:{title:" Gogs RCE 历史漏洞学习笔记",date:"2023-05-25T19:23:23.000Z",tags:["漏洞分析","笔记","靶场","刷题","学习笔记"],published:!0,hideInList:!1,feature:null,isTop:!1}}),(t,ss)=>{const k=d;return p(),E(k,{frontmatter:c(n)},{"main-content-md":e(()=>[u,y,m,b,_,F,f,v,C,D,A,B,N,w,L,R,$,G,x,P,I,S,T,U,j,O,M,V,q,Q,Z,z,H,J,K,W]),"main-header":e(()=>[l(t.$slots,"main-header")]),"main-header-after":e(()=>[l(t.$slots,"main-header-after")]),"main-nav":e(()=>[l(t.$slots,"main-nav")]),"main-content":e(()=>[l(t.$slots,"main-content")]),"main-content-after":e(()=>[l(t.$slots,"main-content-after")]),"main-nav-before":e(()=>[l(t.$slots,"main-nav-before")]),"main-nav-after":e(()=>[l(t.$slots,"main-nav-after")]),comment:e(()=>[l(t.$slots,"comment")]),footer:e(()=>[l(t.$slots,"footer")]),aside:e(()=>[l(t.$slots,"aside")]),"aside-custom":e(()=>[l(t.$slots,"aside-custom")]),default:e(()=>[l(t.$slots,"default")]),_:3},8,["frontmatter"])}}};export{hs as default};
