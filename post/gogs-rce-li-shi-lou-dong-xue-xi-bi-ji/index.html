
<!DOCTYPE html>
<html>
  <head>
    
<meta charset="utf-8" >

<title> Gogs RCE å†å²æ¼æ´å­¦ä¹ ç¬”è®° | æŒå‰‘</title>
<meta name="description" content="ç¢æœˆæ˜Ÿè¾°æ½æ±Ÿé£ , æˆ‘å¿ƒæœ‰å‰‘é—®å¤©æ¶¯ ">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://1dayluo.github.io/favicon.ico?v=1711284755357">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://1dayluo.github.io/styles/main.css">



<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>



  </head>
  <body>
    <div id="app" class="main">
      <div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="https://1dayluo.github.io">
        <img class="avatar" src="https://1dayluo.github.io/images/avatar.png?v=1711284755357" alt="" width="32px" height="32px">
      </a>
      <a href="https://1dayluo.github.io">
        <h1 class="site-title">æŒå‰‘</h1>
      </a>
    </div>
    <div class="right">
      <transition name="fade">
        <i class="icon" :class="{ 'icon-close-outline': menuVisible, 'icon-menu-outline': !menuVisible }" @click="menuVisible = !menuVisible"></i>
      </transition>
    </div>
  </div>
</div>

<transition name="fade">
  <div class="menu-container" style="display: none;" v-show="menuVisible">
    <div class="menu-list">
      
        
          <a href="/" class="menu purple-link">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="menu purple-link">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="menu purple-link">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="menu purple-link">
            å…³äº
          </a>
        
      
    </div>
  </div>
</transition>


      <div class="content-container">
        <div class="post-detail">
          
          <h2 class="post-title"> Gogs RCE å†å²æ¼æ´å­¦ä¹ ç¬”è®°</h2>
          <div class="post-info post-detail-info">
            <span><i class="icon-calendar-outline"></i> 2023-05-25</span>
            
              <span>
                <i class="icon-pricetags-outline"></i>
                
                  <a href="https://1dayluo.github.io/tag/5CW47rOjA1/">
                    å­¦ä¹ ç¬”è®°
                    
                      ï¼Œ
                    
                  </a>
                
                  <a href="https://1dayluo.github.io/tag/7wis0OAqRY/">
                    æ¼æ´åˆ†æ
                    
                      ï¼Œ
                    
                  </a>
                
                  <a href="https://1dayluo.github.io/tag/ZYt2rq1nxl/">
                    ç¬”è®°
                    
                      ï¼Œ
                    
                  </a>
                
                  <a href="https://1dayluo.github.io/tag/np12zpe3Rf/">
                    é¶åœº
                    
                      ï¼Œ
                    
                  </a>
                
                  <a href="https://1dayluo.github.io/tag/Svnemmt1vn/">
                    åˆ·é¢˜
                    
                  </a>
                
              </span>
            
          </div>
          <div class="post-content" v-pre>
            <aside>
ğŸ’¡ This exercise covers how to get code execution against the Git self hosted tool: Gogs.
</aside>
<p>å¤‡æ³¨: gogsçš„è€æ¼æ´å­¦ä¹ ,éæœ€æ–°çš„.é¶åœºå­¦ä¹ çš„, é‡Œé¢æä¾›äº†å¤ç°ç¯å¢ƒ,å°±ä¸ç”¨è‡ªå·±æ­å»ºäº†.</p>
<h2 id="æ¦‚æ‹¬">æ¦‚æ‹¬</h2>
<p>gogsæ˜¯ä¸€ç§æä¾›èƒ½è‡ªå·±æœåŠ¡å™¨ä¸Šæ­å»ºgitæœåŠ¡çš„å¼€æºé¡¹ç›®,å³è‡ªåŠ©git</p>
<p>gogsçš„æ”»å‡»åˆ†ä¸ºä¸¤æ­¥:</p>
<ol>
<li>ç»•è¿‡éªŒè¯å˜ä¸ºadministrator</li>
<li>ä½¿ç”¨hookè·å–å‘½ä»¤æ‰§è¡Œrce</li>
</ol>
<h2 id="æ¼æ´åˆ†æå­¦ä¹ ">æ¼æ´åˆ†æå­¦ä¹ </h2>
<p>åˆ†æä¸»è¦æ˜¯çœ‹Referenceé‡Œçš„æ–‡ç« , å¤§ä½¬æ–‡ç« å†™çš„è¶³å¤Ÿè¯¦ç»†äº†, æˆ‘å°±ç®€å•è®°å½•ä¸€ä¸‹è·Ÿç€æ–‡ç« æ‹çš„æ€è·¯å’Œè‡ªå·±çš„ä¸€äº›æ¢³ç†. å»ºè®®è¿˜æ˜¯çœ‹åŸæ–‡, æœ‰æ›´è¯¦ç»†çš„ä»£ç åˆ†æ(å­¦ä¹ æ—¶å†™è‡ªå·±çš„æ€è·¯ç¬”è®°æ‰æœ‰åŠ©äºç†è§£ä¸æ˜¯å—)</p>
<h3 id="ä¿®å¤çš„å…³é”®ä»£ç ">ä¿®å¤çš„å…³é”®ä»£ç :</h3>
<pre><code class="language-go">// Read returns raw session store by session ID.
func (m *Manager) Read(sid string) (RawStore, error) {
    // No slashes or dots &quot;./&quot; should ever occur in the sid and to prevent session file forgery bug.
    // See https://github.com/gogs/gogs/issues/5469
    if strings.ContainsAny(sid, &quot;./&quot;) {
        return nil, errors.New(&quot;invalid 'sid': &quot; + sid)
    }

    return m.provider.Read(sid)
}
</code></pre>
<p>åˆ©ç”¨æ¡ä»¶:</p>
<ol>
<li>Gogsçš„é…ç½®æ–‡ä»¶æŒ‡å®šsessionå­˜å‚¨æ–¹å¼ä¸ºæ–‡ä»¶</li>
<li>åå°é€»è¾‘(session.go)æ²¡æœ‰è€ƒè™‘åˆ°è¿‡æ»¤ <code>../</code> ç­‰å­—ç¬¦</li>
<li><code>i_like_gogits</code> å¯ä»¥åŠ è½½ä»»æ„æ–‡ä»¶çš„å†…å®¹(åŒ2)</li>
</ol>
<p>å…¶ä¸­:</p>
<ul>
<li>cookieä¸­ <code>i_like_gogits</code> ä¸ºå¯¹åº”sessionæ–‡ä»¶çš„æ–‡ä»¶å, è¿™é‡Œå¯ä»¥æ”¹ä¸ºç®¡ç†å‘˜çš„session</li>
</ul>
<p>è€Œå…¶ä¸­sessionçš„ä¿¡æ¯éœ€è¦äººä¸ºæ„é€ å¹¶ä¸”æ‰¾åˆ°ä¸€ä¸ªä¸Šä¼ ç‚¹</p>
<h3 id="äººä¸ºæ„é€ session">äººä¸ºæ„é€ session:</h3>
<p>sessionç”Ÿæˆæ˜¯ç”± <code>EncodeGob</code> è§£ç åˆ™æ˜¯é€šè¿‡ <code>DecodeGob</code> ,è§£ç å¯¹åº”sessionç„¶åä¿®æ”¹é‡Œé¢çš„uidä¸ºç®¡ç†å‘˜uidå’Œuname, å†ç”±EncodeGobç¼–ç .</p>
<ul>
<li>encoding sessionçš„ä»£ç </li>
</ul>
<pre><code class="language-go">func EncodeGob(obj map[interface{}]interface{}) ([]byte, error) {
    for _, v := range obj {
        gob.Register(v)
    }
    buf := bytes.NewBuffer(nil)
    err := gob.NewEncoder(buf).Encode(obj)
    return buf.Bytes(), err
}
</code></pre>
<p>User ç»“æ„ä½“(<a href="https://github.com/gogs/gogs/blob/be6bb5314ee7d8ed53362d8e6893b061e5210f48/models/user.go#L50-L52">https://github.com/gogs/gogs/blob/be6bb5314ee7d8ed53362d8e6893b061e5210f48/models/user.go#L50-L52</a>)</p>
<pre><code class="language-go">type User struct {
    ID        int64
    LowerName string `xorm:&quot;UNIQUE NOT NULL&quot;`
    Name      string `xorm:&quot;UNIQUE NOT NULL&quot;`
    FullName  string
</code></pre>
<p>è·å–sessionçš„ä»£ç (<a href="https://github.com/gogs/gogs/blob/be6bb5314ee7d8ed53362d8e6893b061e5210f48/routes/user/auth.go#L127-L128">routes/user/auth.go</a>) æ¶‰åŠåˆ°ç”¨æˆ·èº«ä»½çš„æœ‰ä¸¤ä¸ªå€¼</p>
<pre><code class="language-go">c.Session.Set(&quot;uid&quot;, u.ID)
c.Session.Set(&quot;uname&quot;, u.Name)
</code></pre>
<h3 id="ä¸Šä¼ ç‚¹">ä¸Šä¼ ç‚¹</h3>
<p>Gogsæä¾›äº†ä¸‰ç§æ–¹å¼åœ¨æœåŠ¡å™¨ä¸Šä¼ :</p>
<ul>
<li>ä½¿ç”¨issue trackeræä¾›çš„ä¸Šä¼ åŠŸèƒ½ :</li>
<li>ç”¨git push : ä½†æ˜¯å—é™ä¸Šä¼ æ–‡ä»¶ç±»å‹/å†…å®¹è¿‡æ»¤</li>
<li>ä½¿ç”¨upload fileåœ¨ç»™å®šrepository</li>
<li></li>
</ul>
<p>è¿™é‡Œç”¨upload fileä¸ºä¾‹å­,å½“ä½ åˆ›å»ºrepoçš„æ‹·è´å, Gogsä¼šå°†æ–‡ä»¶æ”¾åœ¨ <code>/data/gogs/data/tmp/local-repo/[REPO_ID]/[FILENAME]</code> é‡Œ, è¿™é‡Œrepo_idå¯ä»¥åœ¨forkçš„æ—¶å€™æŸ¥çœ‹é“¾æ¥(é“¾æ¥é‡Œå­ç›®å½•å), å¯¹åº”<a href="https://github.com/gogs/gogs/blob/be6bb5314ee7d8ed53362d8e6893b061e5210f48/models/repo.go#L594-L596">ä»£ç </a>. è¿™é‡Œsessioné»˜è®¤å­˜å‚¨è·¯å¾„ä¸º <code>/**data/gogs/data/sessions/</code> *</p>
<p>æ„é€ å³åœ¨<code>i_like_gogits</code> ä¸­å°†æ–‡ä»¶æŒ‡å‘ç›¸å¯¹è·¯å¾„å³å¯</p>
<figure data-type="image" tabindex="1"><img src="https://i.imgur.com/H7FyjSv.png" alt="" loading="lazy"></figure>
<h3 id="ç™»å½•ååˆ©ç”¨">ç™»å½•ååˆ©ç”¨</h3>
<p>ç”¨çš„gitçš„hookåŠŸèƒ½. å®ç°RCE</p>
<p>git hookä»¥å‰åˆ·é¢˜ç”¨åˆ°è¿‡,è§ <a href="https://1dayluo.github.io/post/htbencoding/#git-commitsh">https://1dayluo.github.io/post/htbencoding/#git-commitsh</a><br>
è¿™é‡Œæ³¨æ„çœ‹ä»“åº“è®¾ç½®é‡ŒGogsæ”¯æŒçš„hook,  æˆ‘åœ¨å¤ç°çš„æ—¶å€™å°±å‘ç°äº†é¶åœºä¸æ”¯æŒpost-commitçš„hook</p>
<h2 id="åæ€">åæ€</h2>
<p>è¿™ä¸ªæ¼æ´æ˜¯ç»å…¸çš„sessionç®¡ç†å’Œæ–‡ä»¶ç›®å½•éå†ç»“åˆçš„æ´, å­¦ä¹ ç»„åˆæ‹³ä»€ä¹ˆçš„â€¦åŒ…æ‹¬ä»£ç å®¡è®¡é‡åˆ°ç±»ä¼¼çš„ä¹Ÿå¯ä»¥(gogsçš„sessionç®¡ç†å’Œphpçš„sessionç®¡ç†æ˜¯ä¸€æ ·çš„æœºåˆ¶)</p>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://www.anquanke.com/post/id/163575">https://www.anquanke.com/post/id/163575</a></li>
<li>Pentesterlab: Green</li>
</ul>

          </div>
        </div>

        
          <div class="next-post">
            <a class="purple-link" href="https://1dayluo.github.io/post/length-extension-attack/">
              <h3 class="post-title">
                ä¸‹ä¸€ç¯‡ï¼šLength Extension Attack
              </h3>
            </a>
          </div>
          
      </div>

      

      <div class="site-footer">
  <div class="slogan">ç¢æœˆæ˜Ÿè¾°æ½æ±Ÿé£ , æˆ‘å¿ƒæœ‰å‰‘é—®å¤©æ¶¯ </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
   | <a class="rss" href="https://1dayluo.github.io/atom.xml" target="_blank">RSS</a>
</div>


    </div>
    <script type="application/javascript">

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>




  </body>
</html>
