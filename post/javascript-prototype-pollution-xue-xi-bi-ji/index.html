
<!DOCTYPE html>
<html>
  <head>
    
<meta charset="utf-8" >

<title>Javascript Prototype Pollution å­¦ä¹ ç¬”è®° | æŒå‰‘</title>
<meta name="description" content="ç¢æœˆæ˜Ÿè¾°æ½æ±Ÿé£ , æˆ‘å¿ƒæœ‰å‰‘é—®å¤©æ¶¯ ">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://1dayluo.github.io/favicon.ico?v=1711284755357">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://1dayluo.github.io/styles/main.css">



<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>



  </head>
  <body>
    <div id="app" class="main">
      <div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="https://1dayluo.github.io">
        <img class="avatar" src="https://1dayluo.github.io/images/avatar.png?v=1711284755357" alt="" width="32px" height="32px">
      </a>
      <a href="https://1dayluo.github.io">
        <h1 class="site-title">æŒå‰‘</h1>
      </a>
    </div>
    <div class="right">
      <transition name="fade">
        <i class="icon" :class="{ 'icon-close-outline': menuVisible, 'icon-menu-outline': !menuVisible }" @click="menuVisible = !menuVisible"></i>
      </transition>
    </div>
  </div>
</div>

<transition name="fade">
  <div class="menu-container" style="display: none;" v-show="menuVisible">
    <div class="menu-list">
      
        
          <a href="/" class="menu purple-link">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="menu purple-link">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="menu purple-link">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="menu purple-link">
            å…³äº
          </a>
        
      
    </div>
  </div>
</transition>


      <div class="content-container">
        <div class="post-detail">
          
          <h2 class="post-title">Javascript Prototype Pollution å­¦ä¹ ç¬”è®°</h2>
          <div class="post-info post-detail-info">
            <span><i class="icon-calendar-outline"></i> 2022-05-26</span>
            
              <span>
                <i class="icon-pricetags-outline"></i>
                
                  <a href="https://1dayluo.github.io/tag/5CW47rOjA1/">
                    å­¦ä¹ ç¬”è®°
                    
                      ï¼Œ
                    
                  </a>
                
                  <a href="https://1dayluo.github.io/tag/XeUA_h891Iz/">
                    javascript
                    
                      ï¼Œ
                    
                  </a>
                
                  <a href="https://1dayluo.github.io/tag/T5kNdXqcRXf/">
                    prototype pollution
                    
                  </a>
                
              </span>
            
          </div>
          <div class="post-content" v-pre>
            <p>ç¬”è®°ä¸­è‹±æ–‡æ··æ‚,é—®å°±æ˜¯æ‡’å¾—ç¿»è¯‘.å­¦ä¹ ç¬”è®°éƒ½æ˜¯äºŒæ¬¡å¸æ”¶,åŸå§‹æ–‡ç« è§Resource&amp;Referenceå¤„. ç¬”è®°åªæ˜¯ç•™ç»™è‡ªå·±å­¦ä¹ åå¤æŸ¥é˜…å’Œç†è§£çš„......å°½å¯èƒ½å†™çš„å¯¹è‡ªå·±æ¥è¯´å…¨é¢ä¸€äº›.</p>
<p><s>å…¶å®å­¦äº†ä¹Ÿè¿˜ä¸ä¼šæ‰¾gadget,æˆ‘éƒ½æƒ³è¦ä¸è¦å»å­¦ä¸‹å‰ç«¯å¼€å‘äº†_(:3_|/_)</s> ä»Šå¤©ä¹Ÿæ˜¯è¢«è‡ªå·±èœåˆ°æŠ‘éƒçš„ä¸€å¤©å‘¢!</p>
<h2 id="intro">Intro</h2>
<p>Prototype Pollution is a vulnerability that allows attackers to exploit the rules of the JavaScript programming language, by injecting properties into existing JavaScript language construct prototypes</p>
<p>ï¼šProperties on the <code>Object.prototype</code> are then inherited by all the JavaScript objects through the prototype chain</p>
<ul>
<li>JavaScript allows all Object attributes to be alteredï¼ŒThis includes their magical attributes such as <code>__**proto__</code>** , <code>constructor</code> and <code>prototype</code></li>
</ul>
<h3 id="impact">impact</h3>
<ul>
<li>Denial of Service: by triggering JavaScript exceptions</li>
<li>RCE: by tampering with the application source code to force the code path that the attacker injects</li>
<li>XSS:</li>
</ul>
<h2 id="base-knowledege">Base Knowledege</h2>
<h3 id="ç†è§£object"><strong>ç†è§£object</strong></h3>
<p>æœ€ç®€å•çš„objectï¼š</p>
<pre><code class="language-jsx">var obj = {};
</code></pre>
<p>è¯¥objectæœ‰ä¸€äº› <code>property</code> :</p>
<ul>
<li><code>obj.__proto__</code></li>
<li><code>obj.constructor</code></li>
<li><code>obj.toString</code></li>
<li>â€¦.</li>
</ul>
<p>In JavaScript, functions can be treated like normal variablesIn JavaScript, functions can be treated like normal variables</p>
<p>so object  methods are definede as properties, like this:</p>
<pre><code class="language-jsx">var o = {name: 'Ivan', surname: 'Ivanov'}
o.foo = function() {
console.log(&quot;foobar&quot;)
}
</code></pre>
<pre><code class="language-jsx">&gt; o.foo()
&lt; foobar
&lt; undefined
</code></pre>
<p>è¿›ä¸€æ­¥ç†è§£ï¼š</p>
<p>The concept of a class in JavaScript starts with a function. The function itself serves as the constructor of the class</p>
<pre><code class="language-jsx">function MyClass() { 
} 
 
var inst = new MyClass();
</code></pre>
<p>è¿™é‡ŒFunctionè¢«æ‰€æœ‰åœ¨åŸå‹ï¼ˆproptotype)ä¸Šå£°æ˜çš„â€œMyClassâ€å®ä¾‹æ‰€ä½¿ç”¨ï¼Œä¸”åŸå‹åœ¨è¿è¡Œæ—¶è¢«ä¿®æ”¹ã€‚è¿™æ„å‘³ç€ä»»ä½•æ—¶å€™éƒ½èƒ½å¤Ÿä¿®æ”¹ä¸€ä¸ªclassçš„prototypeï¼ˆå¢åŠ ï¼Œä¿®æ”¹ï¼Œåˆ é™¤ï¼‰</p>
<p>å›å¤´çœ‹æœ€å¼€å§‹çš„ï¼ˆæœ€ç®€å•çš„objectï¼‰ï¼Œå¯ä»¥ç†è§£ä¸ºè¯¥objectçš„æ„é€ å‡½æ•°å…¶å®æ˜¯ <code>Object</code> ï¼Œè€Œä¾‹å¦‚ <code>toString</code> åˆ™æ˜¯ <code>Object</code> ä¸Šçš„prototypeã€‚</p>
<h3 id="property-access">Property access</h3>
<aside>
ğŸ’¡ Whatâ€™s good to note is that in JavaScript there is no distinction between a property and an instance function
</aside>
<p>è·å–propertyçš„æ–¹æ³•å‚è€ƒ:<a href="https://www.notion.so/Javascript-Prototype-Pollution-232f17fb812543ff9749b1257cee191e">https://www.notion.so/Javascript-Prototype-Pollution-232f17fb812543ff9749b1257cee191e#6856032c4ccf42368be8f7e3e9447c4c</a></p>
<ul>
<li>obj.name</li>
<li>obj[â€nameâ€]</li>
</ul>
<h3 id="object-prototype">Object prototype</h3>
<p>Letâ€™s call  <code>toString()</code> method</p>
<pre><code class="language-jsx">&gt; o.toString()
&lt; &quot;[object Object]&quot;
</code></pre>
<aside>
ğŸ’¡ check the prototype of object o,call use Object.getOwnPropertyNames()
</aside>
<p><strong>Where did the <code>tostring</code> method come from?</strong></p>
<p>Almost any entity is an object that includes arrays, functions, and even class definition!</p>
<p><strong>property</strong>Â <code>[[Prototype]]</code></p>
<p>HowÂ canÂ youÂ useÂ themÂ toÂ implementÂ such aÂ convenientÂ featureÂ ofÂ theÂ classesÂ asÂ inheritance?Â YouÂ canÂ select aÂ specialÂ propertyÂ thatÂ eachÂ objectÂ willÂ have.Â ItÂ willÂ contain aÂ referenceÂ toÂ theÂ parent.Â Let'sÂ callÂ thisÂ propertyÂ <code>[[Prototype]]</code></p>
<p>what if we don't want to inherit all the properties and methods from the parent,Let'sÂ select aÂ specialÂ propertyÂ fromÂ theÂ parentÂ fromÂ whichÂ theÂ propertiesÂ andÂ methodsÂ willÂ beÂ inheritedÂ andÂ callÂ itÂ <code>prototype</code>!</p>
<p>When you access an object property via <a href="http://o.name/">o.name</a> or o['name'] actually does the following:</p>
<ol>
<li>TheÂ JavaScriptÂ engineÂ searchesÂ forÂ theÂ <code>name</code>Â propertyÂ inÂ theÂ <code>o</code>Â object.</li>
<li>IfÂ theÂ propertyÂ isÂ present,Â itÂ isÂ returned.Â Otherwise,Â theÂ prototypeÂ ofÂ theÂ <code>o</code>Â objectÂ isÂ takenÂ andÂ theÂ propertyÂ isÂ searchedÂ forÂ inÂ it!</li>
</ol>
<p>So it turns out that the <code>toString()</code> method is actually defined in <code>Object.prototype</code></p>
<pre><code class="language-jsx">&gt; o.__proto__
&lt; {constructor: Æ’, __defineGetter__: Æ’, __defineSetter__: Æ’, hasOwnProperty: Æ’, __lookupGetter__: Æ’, â€¦}
&gt; o.__proto__.__proto__
&lt; null
</code></pre>
<p>ä¸€ç›´åˆ°nullçš„è¿™æ¡prototypesçš„é“¾æ¡ç§°ä¸ºåŸå‹é“¾</p>
<p>ğŸ“¢ By the way, the word â€œprototypeâ€ in JavaScript can refer to at least three different things, depending on the context:</p>
<ul>
<li>Internal property [[Prototype]]. It is called internal because it lives in the &quot;guts&quot; of the JavaScript engine, we only get access to it through the special functions <strong>proto</strong>, Object.getPrototypeOf(), and others.</li>
<li>TheÂ prototypeÂ property:Â Object.prototype,Â Function.prototype,Â andÂ others.</li>
<li>The <strong>proto</strong> property. A rare and not quite correct use, because technically <strong>proto</strong> is a getter / setter and only gets a reference to the prototype of the object and returns it.</li>
</ul>
<h3 id="__proto__-å’Œ-prototypeçš„åŒºåˆ«"><code>__proto__</code> å’Œ prototypeçš„åŒºåˆ«</h3>
<p>é¦–å…ˆ <code>class</code> æ˜¯è¯­æ³•ç³–,</p>
<p><code>prototype</code> (åŸå‹)ç”¨äºå£°æ˜ç±»æ—¶,åˆ›å»ºç±»ä¸‹çš„æ–¹æ³•(ä¸ç„¶ä¼šæ–°å»ºå¯¹è±¡,å…¶ä¸‹çš„æ–¹æ³•å°±ä¼šæ‰§è¡Œä¸€æ¬¡),<strong>å¯ä»¥è®¤ä¸ºprototypeæ˜¯ç±» <code>Foo</code> çš„ä¸€ä¸ªå±æ€§.</strong></p>
<pre><code class="language-jsx">function Foo() {
    this.bar = 1
}

Foo.prototype.show = function show() {
    console.log(this.bar)
}

let foo = new Foo()
foo.show()
</code></pre>
<p>ç±»å¯¹è±¡åœ¨å®ä¾‹åŒ–çš„æ—¶å€™,ä¼šæ‹¥æœ‰prototypeä¸­å“¦ä½ æ„ŸåŠ¨å±æ€§å’Œæ–¹æ³•</p>
<p><code>__proto__</code> ç”¨äºè®¿é—®åŸå‹(prototype), å³</p>
<pre><code class="language-jsx">foo.__proto__ == Foo.prototype
</code></pre>
<h3 id="åŸå‹é“¾ç»§æ‰¿">åŸå‹é“¾ç»§æ‰¿</h3>
<p>åŸå‹é“¾çš„æŸ¥æ‰¾å‘ç”Ÿåœ¨å¯¹è±¡ä¸Š.</p>
<ol>
<li>æ¯ä¸ªæ„é€ å‡½æ•°(constructor)éƒ½æœ‰ä¸€ä¸ªåŸå‹å¯¹è±¡(prototype)</li>
<li>å¯¹è±¡çš„<code>__proto__</code>å±æ€§ï¼ŒæŒ‡å‘ç±»çš„åŸå‹å¯¹è±¡<code>prototype</code></li>
<li>JavaScriptä½¿ç”¨prototypeé“¾å®ç°ç»§æ‰¿æœºåˆ¶</li>
</ol>
<h2 id="what-is-prototype-pollution">What is prototype pollution?</h2>
<blockquote>
<p>TheÂ termÂ prototypeÂ pollutionÂ refersÂ toÂ theÂ situationÂ whenÂ theÂ <code>prototype</code><br>
Â propertyÂ ofÂ <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects#fundamental_objects">fundamentalÂ objects</a><br>
Â isÂ changed.</p>
</blockquote>
<p>what prototype pollution look like in the code</p>
<pre><code class="language-jsx">var o = {};
var a = process.argv[2];
var b = 'test';
var v = process.argv[3];

console.log(({}).test);

o[a][b] = v;

console.log(({}).test);
</code></pre>
<p>attacker controls the parameters <code>a</code> and <code>v</code> ,they can:</p>
<ul>
<li><code>v = __proto__</code></li>
</ul>
<h2 id="base-sample">base sample:</h2>
<p>sample 1:</p>
<pre><code class="language-jsx">let someObject = {}
let user = {}

console.assert(user.isAdmin === true)
// Rerturn:Assertion failed

someObject.__proto__.isAdmin = true

console.assert(user.isAdmin === true)
// Return:udefined
</code></pre>
<p>sample 2</p>
<pre><code class="language-jsx">// fooæ˜¯ä¸€ä¸ªç®€å•çš„JavaScriptå¯¹è±¡
let foo = {bar: 1}

// foo.bar æ­¤æ—¶ä¸º1
console.log(foo.bar)

// ä¿®æ”¹fooçš„åŸå‹ï¼ˆå³Objectï¼‰
foo.__proto__.bar = 2

// ç”±äºæŸ¥æ‰¾é¡ºåºçš„åŸå› ï¼Œfoo.barä»ç„¶æ˜¯1
console.log(foo.bar)

// æ­¤æ—¶å†ç”¨Objectåˆ›å»ºä¸€ä¸ªç©ºçš„zooå¯¹è±¡
let zoo = {}

// æŸ¥çœ‹zoo.bar
console.log(zoo.bar)
</code></pre>
<p>sample3</p>
<pre><code class="language-jsx">let o1 = {}
let o2 = JSON.parse('{&quot;a&quot;: 1, &quot;__proto__&quot;: {&quot;b&quot;: 2}}')
merge(o1, o2)
console.log(o1.a, o1.b)

o3 = {}
console.log(o3.b)
</code></pre>
<p>JSONè§£æçš„æƒ…å†µä¸‹ï¼Œ<code>__proto__</code><br>
ä¼šè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªçœŸæ­£çš„â€œé”®åâ€ï¼Œè€Œä¸ä»£è¡¨â€œåŸå‹â€ï¼Œæ‰€ä»¥åœ¨éå†o2çš„æ—¶å€™ä¼šå­˜åœ¨è¿™ä¸ªé”®ã€‚</p>
<h2 id="detection">Detection</h2>
<p>è¯¥èŠ‚å‚è€ƒ:<a href="https://blog.s1r1us.ninja/research/PP">https://blog.s1r1us.ninja/research/PP</a></p>
<h3 id="case-1">Case 1</h3>
<p>æ£€æŸ¥ <code>query/hash</code></p>
<p>è¯¥ä¾‹å­ä½¿ç”¨äº†<a href="https://www.google.com/url?q=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fcan-deparam&amp;sa=D&amp;sntz=1&amp;usg=AOvVaw220_I7_8edi7_BK19uQKBF">canjs-deparam</a> åº“å»è§£æqueryå‚æ•°</p>
<pre><code class="language-jsx">keyBreaker = /([^\[\]]+)|(\[\])/g,
...
module.exports = namespace.deparam = function (params, valueDeserializer) {
    valueDeserializer = valueDeserializer || idenity;
    var data = {}, pairs, lastPart;
    if (params &amp;&amp; paramTest.test(params)) {
        pairs = params.split('&amp;');
        pairs.forEach(function (pair) {
            var parts = pair.split('='),
                key = prep(parts.shift()),
                value = prep(parts.join('=')),
                current = data;
            if (key) {
                parts = key.match(keyBreaker);
                for (var j = 0, l = parts.length - 1; j &lt; l; j++) {
                    var currentName = parts[j],
                        nextName = parts[j + 1],
                        currentIsArray = isArrayLikeName(currentName) &amp;&amp; current instanceof Array;
                    if (!current[currentName]) {
                        if(currentIsArray) {
                            current.push( isArrayLikeName(nextName) ? [] : {} );
                        } else {
                            // If what we are pointing to looks like an `array`
                            current[currentName] = isArrayLikeName(nextName) ? [] : {};
                        }

                    }
                    if(currentIsArray) {
                        current = current[current.length - 1];
                    } else {
                        current = current[currentName];
                    }

                }
                lastPart = parts.pop();
                if ( isArrayLikeName(lastPart) ) {
                    current.push(valueDeserializer(value));
                } else {
                    current[lastPart] = valueDeserializer(value);
                }
            }
        });
    }
    return data;
}; 
var obj = deparam(location.hash.substr(1))
</code></pre>
<p>ä¾‹å¦‚ä¸Šé¢çš„ä¾‹å­,æ£€æµ‹æ˜¯å¦å­˜åœ¨åŸå‹é“¾æ±¡æŸ“è§£æçš„æ–¹å¼æ˜¯éå†ä¸åŒçš„åŸå‹é“¾æ±¡æŸ“payloadåœ¨ <code>location.hash</code> å’Œ <code>location.search</code> ä¸­:</p>
<pre><code class="language-jsx">x[__proto__][abaeead] = abaeead

x.__proto__.edcbcab = edcbcab

__proto__[eedffcb] = eedffcb

__proto__.baaebfc = baaebfc
</code></pre>
<h3 id="case-2">Case 2</h3>
<p>è¿™ä¸ªä¾‹å­é‡Œ,æˆ‘ä»¬æ£€æŸ¥ä¸€äº›ä½äºå®¢æˆ·ç«¯çš„<strong>ç”¨æˆ·è¾“å…¥</strong>æˆ–ä¸€äº›<strong>data/responseå¤„ç†</strong>çš„åŠŸèƒ½,ä¼šå¯¼è‡´åŸå‹é“¾æ±¡æŸ“.å¤§éƒ¨åˆ†æ—¶å€™,è¿™ä¸ªå°†å¯¼è‡´self-XSS,è¿™æ˜¯å› ä¸ºæ”»å‡»è€…æ— æ³•æ§åˆ¶ä¾‹å¦‚case1çš„æ¥è‡ªäºlocationçš„è¾“å…¥,ä½†,å¤§éƒ¨åˆ†æ—¶å€™,self-XSSèƒ½è½¬æ¢ä¸ºreflected XSS</p>
<p>è¿™éƒ¨åˆ†è‡ªåŠ¨åŒ–ä½¿ç”¨CodeQL,éœ€è¦ä¸‹è½½å…¨éƒ¨çš„javascript,ç„¶ååˆ›å»ºCodeQLæ•°æ®åº“å¹¶æ‰«ææ˜¯å¦æœ‰jsä¼šå¯¼è‡´prototype pollution</p>
<h3 id="property-definition-by-pathlocation"><strong><strong>Property definition by path/location</strong></strong></h3>
<aside>
ğŸ’¡ There are numerous JavaScript libraries which are vulnerable to Prototype Pollution due toÂ *`document.location`*
</aside>
<p>Prototype pollution listï¼šhttps://github.com/BlackFan/client-side-prototype-pollution</p>
<ul>
<li>see al available properties of the Object: <code>Object.prototyp</code></li>
</ul>
<p>you can polluteï¼š</p>
<ul>
<li>polluting all the object with the new attribute (reference <a href="https://www.notion.so/JSON-__proto__-o2-a379ece6dec24bdd87fe60bc39932a04">JSONè§£æçš„æƒ…å†µä¸‹ï¼Œ<code>__proto__</code><br>
ä¼šè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªçœŸæ­£çš„â€œé”®åâ€ï¼Œè€Œä¸ä»£è¡¨â€œåŸå‹â€ï¼Œæ‰€ä»¥åœ¨éå†o2çš„æ—¶å€™ä¼šå­˜åœ¨è¿™ä¸ªé”®ã€‚</a> ï¼‰</li>
<li>polluting the DOM ï¼ˆreference <a href="https://www.notion.so/e19fee3d65fb47309c476cb7e103536b"></a>  )</li>
</ul>
<p><strong>unsafe merge recurses</strong></p>
<p><code>lodash</code>andÂ <code>Hoek</code> are examples of libraries susceptible to recursive merge attacks.</p>
<p>ç®€è¿°åŸå‹æ±¡æŸ“ä¸‹merge recursesæ­¥éª¤ï¼š</p>
<ul>
<li>æ£€æŸ¥æºä»£ç æ˜¯å¦åŒ…å« <code>__proto__</code> å±æ€§ï¼ˆè¢« <code>Object.definProperty()</code> å‘½åçš„ï¼‰ï¼Œå±æ€§å­˜åœ¨ä¸”ä¸€ä¸ªobjectæ—¢åœ¨ç›®æ ‡ä¹Ÿåœ¨æºä»£ç ä¸­,ä¸”åœ¨ç›®æ ‡ä¸Šåˆå¹¶é€’å½’</li>
<li>æ”»å‡»è€…å®šä¹‰ <code>Object</code> æ¥æºï¼Œå°†propertieså¤åˆ¶åˆ° <code>Object</code> çš„prototypeä¸Š</li>
</ul>
<aside>
ğŸ’¡ Clone operationsæ˜¯unsafe recursive mergesçš„ä¸€ä¸ªç‰¹æ®Šå­ç±»ï¼šå‘ç”Ÿåœ¨recursive mergesçš„å¯¹è±¡æ˜¯ç©ºçš„Object. `merge({},source)`
</aside>
<p><strong>Example 1</strong></p>
<aside>
ğŸ’¡ The impact and severity of Prototype Pollution depends on the application. Property definition by path/location is a key example.
</aside>
<p>we create object Book asï¼š</p>
<pre><code class="language-jsx">var book = {bookName: &quot;Book name&quot;, authorName: &quot;Author of book&quot;};
</code></pre>
<p>we can use <code>book.bookName</code> or <code>book[&quot;bookName&quot;]</code>  to get the bookâ€™s name</p>
<ul>
<li>
<p>not work:</p>
<pre><code class="language-jsx">*book.constructor.protoSomeRandomName // this will not work, since there is no attribute protoSomeRandomName*
</code></pre>
</li>
<li>
<p>work:</p>
<pre><code class="language-jsx">Object.__proto__[&quot;protoSomeRandomName&quot;]=&quot;protoSomeRandomValue&quot;
book.constructor.protoSomeRandomName // this will work and return value protoSomeRandomValue
</code></pre>
<ul>
<li>We proved this indeed polluted all the objects created from the object Object with the new attribute,and all of these new objects have inherited this attribute from the prototype.</li>
</ul>
</li>
<li>
<p>other ways:</p>
<pre><code class="language-jsx">Object.__proto__[&quot;protoSomeRandomName&quot;]=&quot;protoSomeRandomValue&quot;
Object.__proto__.protoSomeRandomName=&quot;protoSomeRandomValue&quot;
Object.constructor.prototype.protoSomeRandomName=&quot;protoSomeRandomValue&quot;
Object.constructor[&quot;prototype&quot;][&quot;protoSomeRandomName&quot;]=&quot;protoSomeRandomValue&quot;
</code></pre>
</li>
</ul>
<h3 id="vulnerable-documentlocation-parsers">**<strong>vulnerableÂ <em>document.location</em>Â parsers</strong></h3>
<p><em>Credits go to:Â <a href="https://github.com/msrkp">s1r1us</a></em></p>
<p>æœ‰å…³çš„æ–‡ç« :</p>
<ul>
<li><a href="https://blog.s1r1us.ninja/research/PP">https://blog.s1r1us.ninja/research/PP</a></li>
</ul>
<p>ç›¸å…³å­¦ä¹ ç¬”è®°</p>
<p><a href="https://www.notion.so/document-location-c10ca99b748145849ac793d1ff47ce0e"><em><strong><strong>document.location é¶åœºç»ƒä¹ ç¬”è®°</strong></strong></em></a></p>
<p><strong>Example 1 : <code>jquery-deparam</code>.</strong></p>
<p><a href="https://msrkp.github.io/pp/1.html?__proto__%5BprotoSomeRandomName%5D=protoSomeRandomValue">https://msrkp.github.io/pp/1.html?<strong>proto</strong>[protoSomeRandomName]=protoSomeRandomValue</a></p>
<p>related :<br>
<a href="https://security.snyk.io/vuln/SNYK-JS-JQUERYDEPARAM-1255651">https://security.snyk.io/vuln/SNYK-JS-JQUERYDEPARAM-1255651</a></p>
<p><strong>Example 2</strong></p>
<p><a href="https://msrkp.github.io/pp/2.html?__proto__%5BprotoSomeRandomName%5D=protoSomeRandomValue">https://msrkp.github.io/pp/2.html?<strong>proto</strong>[protoSomeRandomName]=protoSomeRandomValue</a></p>
<p><strong>Example 3</strong></p>
<p><a href="https://msrkp.github.io/pp/3.html?__proto__%5BprotoSomeRandomName%5D=protoSomeRandomValue">https://msrkp.github.io/pp/3.html?<strong>proto</strong>[protoSomeRandomName]=protoSomeRandomValue</a></p>
<h2 id="identifying-the-vulnerable-library">Identifying the vulnerable library</h2>
<p>æˆ‘ä»¬ä¸‹ä¸€æ­¥éœ€è¦:</p>
<ul>
<li>è¯†åˆ«å­˜åœ¨æ¼æ´çš„library</li>
<li>æ˜ç¡®å…·ä½“é‚£ä¸€è¡ŒåŸå‹é“¾è¢«æ±¡æŸ“</li>
<li>å“ªäº›æ±¡æŸ“ç»“æœå­˜å‚¨åœ¨äº†æ•°æ®åº“ä¸­</li>
</ul>
<p>å¦‚æœapplicationä¸å¤æ‚,å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å…³é”®è¯: <code>location.hash/decodeURIComponent/location.search</code></p>
<h3 id="blocking-the-js-resource-request-in-firefox">Blocking the JS resource request in Firefox</h3>
<figure data-type="image" tabindex="1"><img src="https://cdn.jsdelivr.net/gh/1dayluo/PicGo4Blog/data/Untitled.png20220526_a.png" alt="Untitled" loading="lazy"></figure>
<p>ä¸ºäº†ç¡®è®¤å¯¹åº”çš„jsæºæ–‡ä»¶æ˜¯å¦å¯¼è‡´äº†åŸå‹é“¾æ±¡æŸ“.æˆ‘ä»¬å¯ä»¥block url ,ç„¶åç¡®è®¤è¢«æ±¡æŸ“çš„propertyæ˜¯å¦ä¸º <code>undefined</code> ,å¦‚æœæ˜¯,åˆ™ç¡®è®¤è¯¥jsæºæ–‡ä»¶å¯¼è‡´äº†åŸå‹é“¾æ±¡æŸ“</p>
<h3 id="debugger-breakpoint-on-setter">Debugger Breakpoint on setter</h3>
<p>This technique is easier than others, we can set a breakpoint when the property is set to Obect.prototype.</p>
<p>![Untitled](https://cdn.jsdelivr.net/gh/1dayluo/PicGo4Blog/data/Untitled 1.png20220526_a.png)</p>
<pre><code class="language-jsx">function breakpoint(obj, prop){

	var tmp = obj[prop];

       Object.defineProperty(obj, prop, {

           set: function(val) {

               debugger;

               return tmp = val;

           }

       });

   };
</code></pre>
<h3 id="sensitive-function">sensitive function</h3>
<p>javascript:</p>
<ul>
<li><code>Object.assign</code></li>
</ul>
<p>npmjs/jquery</p>
<ul>
<li><code>canjs-deparam</code> - deparam</li>
</ul>
<h2 id="finding-script-gadgets">Finding Script Gadgets</h2>
<h3 id="what-is-a-script-gadget">What is a script gadget?</h3>
<p>å®šä¹‰</p>
<p>On the client-side, the escalation to XSS is the most interesting. The JavaScript code that can be used to escalate prototype pollution to other vulnerability is called a gadget.</p>
<p>åœ¨ç¡®è®¤äº†propertyè¢«æ±¡æŸ“å,  æ˜¯å¦æœ‰application logicæˆ–åŠŸèƒ½ç‚¹èƒ½å¯¼è‡´javascript execution.</p>
<p>è¿™é‡Œä¸¾çš„ä¾‹å­æ˜¯SwiftType Search libraryä¸­çš„script gadget,è¯¥payloadä¼šå¯¼è‡´XSS:</p>
<pre><code class="language-jsx">https://example.com/#__proto__[xxx]=alert(1)
</code></pre>
<p>ä»¥ä¸‹æ˜¯å¯¼è‡´äº§ç”Ÿalertçš„ä»£ç ç‰‡æ®µ(script gadget), <code>$.each</code> éå† <code>this._userServerConfiguration.install.hooks</code> å¯¹è±¡ä»¥åŠä½äºåŸå‹(prototype)ä¸Šçš„å±æ€§,è¿™å°†å¯¼è‡´æˆ‘ä»¬æ±¡æŸ“çš„åŸå‹ <code>xxx</code> è¢«æ‰§è¡Œ</p>
<pre><code class="language-jsx">each: function(t, e, i) {

   /*removed for brevity*/
     else
         for (o in t)
             if (r = e.call(t[o], o, t[o]),
             r === !1)
                 break;

     return t

 }

pInstall._convertStringHooksToFunctions = function() {

   var functionHooks = {};

   $.each(this._userServerConfiguration.install.hooks, function(hookName, hookFunction) {

       functionHooks[hookName] = eval(hookFunction)

   }),

   this._userServerConfiguration.install.hooks = functionHooks

}
</code></pre>
<h3 id="using-existing-gadgets">using existing gadgets</h3>
<p>First of all, it makes sense to check the existing gadgets in the <a href="https://github.com/BlackFan/client-side-prototype-pollution">BlackFan/client-side-prototype-pollution</a> repository or in the <a href="https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution">Cross-site scripting (XSS) cheat sheet.</a></p>
<ul>
<li>Using theÂ <a href="https://chrome.google.com/webstore/detail/wappalyzer/gppongmhjkpfnbhagpmjfkannfbllamg?hl=en">Wappalyzer</a>Â plugin.</li>
<li>Using a scriptÂ <a href="https://gist.github.com/nikitastupin/b3b64a9f8c0eb74ce37626860193eaec">fingerprint.js</a>.</li>
</ul>
<p>fingerprint.jsä½¿ç”¨æ–¹å¼:</p>
<ul>
<li>
<p>Copy the script and execute it in the context of the vulnerable page.</p>
<p>![Untitled](https://cdn.jsdelivr.net/gh/1dayluo/PicGo4Blog/data/Untitled 2.png20220526_a.png)</p>
<ul>
<li><em><a href="https://gist.github.com/nikitastupin/b3b64a9f8c0eb74ce37626860193eaec">fingerprint.js</a>Â shows that the page has a Twitter Universal Website Tag gadget</em></li>
</ul>
</li>
<li>
<p>å»https://github.com/BlackFan/client-side-prototype-pollution æœå…³é”®è¯â€Universal Website Tagâ€ å‘ç°å·²çŸ¥gadget</p>
</li>
<li>
<p>æ‰¾åˆ°åæµ‹è¯•:we are interested in theÂ <a href="https://github.com/BlackFan/client-side-prototype-pollution/blob/004bf5353f6f30b720f3d68c5aca5191531f35d6/gadgets/twitter-uwt.md#poc">PoC</a>Â section with a ready-made payload. Trying out a payload on a vulnerable siteÂ <code>[https://ctf.nikitastupin.com/pp/known.html?__proto__[hif][]=javascript:alert(document.domain)](https://ctf.nikitastupin.com/pp/known.html?__proto__[hif][]=javascript:alert(document.domain).)</code></p>
</li>
</ul>
<h3 id="finding-new-gadgets">ğŸ‘ Finding new gadgets</h3>
<p>like this: <code>[https://ctf.nikitastupin.com/pp/unknown.html?__proto__[polluted]=31337](https://ctf.nikitastupin.com/pp/unknown.html?__proto__[polluted]=31337.)</code></p>
<p>Despite the fact that Wappalyzer reports the presence of jQuery,this is a false positive due to the jquery-deparam library that is used on the site</p>
<p>There are several approaches to finding new gadgets:</p>
<ol>
<li><a href="https://github.com/filedescriptor/untrusted-types/tree/old">filedescriptor/untrusted-types</a>. At the time of writing, there are two versions of the plugin:Â <code>main</code>Â andÂ <code>old</code>. We will useÂ <code>old</code>Â because it is simpler thanÂ <code>main</code>. This plugin was originally developed for DOM XSS search, details can be found in the videoÂ <a href="https://youtu.be/CNNCCgDkt5k">Finding DOMXSS with DevTools | Untrusted Types Chrome Extension</a>.</li>
<li><a href="https://github.com/securitum/research/tree/master/r2020_prototype-pollution">pollute.js</a>. How this tool works, as well as what vulnerabilities it allowed you to find, can be read in the articleÂ <a href="https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/">Prototype pollution â€” and bypassing client-side HTML sanitizers</a>.</li>
<li>Search with your hands, using the debugger.</li>
</ol>
<p>æ¡ˆä¾‹è¯·çœ‹<a href="https://infosecwriteups.com/javascript-prototype-pollution-practice-of-finding-and-exploitation-f97284333b2">https://infosecwriteups.com/javascript-prototype-pollution-practice-of-finding-and-exploitation-f97284333b2</a> ä¸‹çš„Edge case æ¥è¿‘äºç°å®çš„æ¡ˆä¾‹.éå¸¸ç²¾å½©çš„åˆ†æè¿‡ç¨‹</p>
<h3 id="keyword-search-and-source-code-review">Keyword search and Source Code Review</h3>
<p>if application is simple,we can search for keywords like:</p>
<ul>
<li><code>srcdoc</code></li>
<li><code>innerHTML</code></li>
<li><code>iframe</code></li>
<li><code>crateElement</code></li>
</ul>
<p>review the source code and check if it leads to javascript execution.</p>
<p>Sometimes, mentioned techniques might not find gadgets at all.</p>
<p>In that case, pure source code review reveals some nice gadgets like the below example.</p>
<h3 id="jquery-example">jQuery example</h3>
<p>BlackFan found this cool gadget in jQuery with source code review.</p>
<pre><code class="language-jsx">&lt;script/src=https://code.jquery.com/jquery-3.3.1.js&gt;&lt;/script&gt;

&lt;script&gt;

 Object.prototype.preventDefault='x'

 Object.prototype.handleObj='x'

 Object.prototype.delegateTarget='&lt;img/src/onerror=alert(1)&gt;'

 /* No extra code needed for jQuery 1 &amp; 2 */

 $(document).off('foobar');

&lt;/script&gt;
</code></pre>
<p>Here is the piece of code which is responsible for the gadget which is self explanatory.</p>
<pre><code class="language-jsx">https://github.com/jquery/jquery/blob/5c2d08704e289dd2745bcb0557b35a9c0e6af4a4/src/event.js#L798

if ( types &amp;&amp; types.preventDefault &amp;&amp; types.handleObj ) {

   handleObj = types.handleObj;

   jQuery( types.delegateTarget ).off(

       handleObj.namespace ?

           handleObj.origType + &quot;.&quot; + handleObj.namespace :

           handleObj.origType,

       handleObj.selector,

       handleObj.handler

   );

   return this;

}
</code></pre>
<h2 id="server-side-prototype-pollution">Server-side prototype pollution</h2>
<p>It all started with theÂ <a href="https://youtu.be/LUsiFV3dsK8">Olivier Arteau â€” Prototype pollution attacks in NodeJS applications</a>Â <br>
,Â <a href="https://github.com/HoLyVieR/prototype-pollution-nsec18">prototype-pollution-nsec18</a>.Oliver discovered the prototype pollution vulnerability inÂ <a href="https://hackerone.com/holyvier?filter=type%3Apublic&amp;type=user">several npm packages</a>, including one of the most popularÂ <a href="https://www.npmjs.com/package/lodash">lodash</a>Â packages (Â <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-3721">CVE-2018â€“3721</a>). The lodash package is used in many applications and packages of the JavaScript ecosystem. In particular, it is used in the popularÂ <a href="https://github.com/TryGhost/Ghost">Ghost</a> CMS</p>
<h3 id="finding-prototype-pollution">Finding prototype pollution</h3>
<p>æ²¡æœ‰æºä»£ç è¿™ç±»æ¼æ´å¾ˆéš¾è¢«æ£€æµ‹å’Œåˆ©ç”¨(æœ‰CVEå’Œç°æˆçš„payloadé™¤å¤–).</p>
<p>å‡è®¾,æˆ‘ä»¬æœ‰æºä»£ç ,ä»£ç ä¸­å“ªäº›åœ°æ–¹å€¼å¾—è¢«æ³¨æ„,æ¼æ´æœ€å¸¸è§çš„åœ°æ–¹åœ¨å“ªé‡Œ?</p>
<p><strong>What language constructs are prone to the vulnerability?</strong></p>
<p>Most often, prototype pollution is found in the following constructs / operations:</p>
<ul>
<li>recursive merging of objects (for example,Â <a href="https://github.com/jonschlinkert/merge-deep">jonschlinkert/merge-deep</a>)</li>
<li>cloning an object (for example,Â <a href="https://github.com/jonschlinkert/clone-deep">jonschlinkert/clone-deep</a>)</li>
<li>converting GET parameters to a JavaScript object (for example,Â <a href="https://github.com/AceMetrix/jquery-deparam">AceMetrix/jquery-deparam</a>)</li>
<li>convertÂ <code>.toml</code>Â orÂ <code>.ini</code>Â configuration files to a JavaScript object (for example,Â <a href="https://github.com/npm/ini">npm/ini</a>)</li>
</ul>
<p>We can trace a pattern: those operations that take a complex data structure (for example,Â <code>.toml</code><br>
) as input and convert it into a JavaScript object are vulnerable</p>
<h3 id="dynamic-analysis">Dynamic analysis</h3>
<p>Letâ€™s start with dynamic, as it is easier to understand and apply. The algorithm is quite simple and is already implemented inÂ <a href="https://github.com/HoLyVieR/prototype-pollution-nsec18/tree/master/find-vuln">find-vuln</a>:</p>
<ol>
<li>Download the npm package.</li>
<li>Call each function in the package, with a pagelode as an argument.</li>
<li>Check whether the vulnerability has worked.</li>
</ol>
<p>The only drawback ofÂ <a href="https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/find-vuln/find-vuln.js">find-vuln.js</a>Â is that it doesnâ€™t checkÂ <code>constructor.prototype</code> and therefore misses some of the vulnerabilities, but this gap is easy enough to fix.In general, making small changes toÂ <a href="https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/find-vuln/find-vuln.js">find-vuln.js</a>Â even now you can find vulnerabilities in npm packages.</p>
<h3 id="static-analysis">static analysis</h3>
<p><a href="https://github.com/github/codeql/tree/main/javascript/ql/src/Security/CWE-915">CodeQL queries</a></p>
<h3 id="impact-2">impact</h3>
<p>åœ¨NodeJSç¯å¢ƒé‡Œ:</p>
<ul>
<li>guaranteed DoS:can overwrite a basic function</li>
</ul>
<h3 id="vuln-in-template-engines">vuln in template engines</h3>
<p>In a web application, often you can spin up to remote code execution. Normally, this is done with the template engines. The details of the operation can be found in the articles below.</p>
<ul>
<li><a href="https://blog.p6.is/AST-Injection/">AST Injection, Prototype Pollution to RCE</a></li>
<li><a href="https://blog.p6.is/Real-World-JS-1/">Real-world JS â€” 1</a></li>
<li><a href="https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/paper/JavaScript_prototype_pollution_attack_in_NodeJS.pdf">Prototype pollution attack in NodeJS application</a></li>
</ul>
<h2 id="nextjs">Next.js</h2>
<p>you need know:</p>
<ul>
<li>Amp</li>
</ul>
<p>escape sandbox</p>
<p>[16:49]</p>
<p>![Untitled](https://cdn.jsdelivr.net/gh/1dayluo/PicGo4Blog/data/Untitled 3.png20220526_a.png)</p>
<h2 id="mitigation">Mitigation</h2>
<p>ä¸¤ç§æ¯”è¾ƒå¸¸ç”¨çš„æ–¹æ³•:</p>
<ul>
<li>å­—æ®µé»‘åå•(Field black list)</li>
<li>Jsonæ¨¡å¼(JSON schema)</li>
</ul>
<h3 id="field-black-list">Field black list</h3>
<p>å¤§éƒ¨åˆ†å¼€å‘è€…æ˜¯æ·»åŠ  <code>__proto__</code> åˆ°é»‘åå•(ä¸æ¨è)</p>
<p>é»‘åå•æ¨è:</p>
<ul>
<li><code>constructor.prototype</code>
<ul>
<li>ä¼˜ç‚¹:èƒ½ä¿®å¤å¤§éƒ¨åˆ†é—®é¢˜,ä½†æ˜¯åŒæ—¶å®ƒæ²¡æœ‰å®Œå…¨è§£å†³é—®é¢˜</li>
<li>ç¼ºç‚¹:ä»ç„¶å­˜åœ¨ä¿®æ”¹ <code>Object.prototype</code> å’Œå…¶ä»– <code>prototype</code> é—®é¢˜</li>
</ul>
</li>
<li><code>Object.create(null)</code>
<ul>
<li>ä¼˜ç‚¹:ä½¿ç”¨æ²¡æœ‰prototypeçš„object,è¿™æ ·ä¿®æ”¹prototypeå°†å˜å¾—ä¸å¯èƒ½</li>
<li>ç¼ºç‚¹:å¯¹åŠŸèƒ½æ€§æœ‰äº›æŸå¤±,ä¾‹å¦‚æœ‰äººæƒ³ç”¨ <code>toString()</code> çš„åœºæ™¯,ä½†ä¼šè¢«æç¤º <code>o.toString is not a function</code></li>
</ul>
</li>
<li><code>Object.freeze()</code>
<ul>
<li>ä¼˜ç‚¹:ä½¿ç”¨ <code>Object.freeze()</code> æ¥å†»ç»“ <code>Object.prototype</code> ,è¿™æ ·,åœ¨è¿™ä¹‹å, <code>Object.prototype</code> ä¸èƒ½è¢«ä¿®æ”¹.</li>
<li>ç¼ºç‚¹/pitfalls:
<ul>
<li>ä¿®æ”¹ <code>Object.prototype</code> çš„ä¾èµ–å…³ç³»å¯èƒ½è¢«ä¸­æ–­</li>
<li>é€šå¸¸ä¹Ÿéœ€è¦å†»ç»“ <code>Array.prototype</code> å’Œå…¶ä»–object</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="json-schema">JSON schema</h3>
<p>éªŒè¯é€šè¿‡<a href="https://json-schema.org/">JSON schema</a>é¢„å®šä¹‰çš„è¾“å…¥æ•°æ®,å¹¶ä¸¢å¼ƒå…¶ä»–å‚æ•°</p>
<p>For example, you can do this using theÂ <a href="https://github.com/ajv-validator/ajv">avj</a> library with theÂ <code>additionalProperties = false</code><br>
Â parameter.</p>
<h2 id="resourcereference">Resource&amp;Reference:</h2>
<p><strong>Video:</strong></p>
<ul>
<li><a href="https://www.youtube.com/watch?v=XS_UMqQalLI">https://www.youtube.com/watch?v=XS_UMqQalLI</a></li>
<li><a href="https://www.youtube.com/watch?v=oGeEoaplMWA">https://www.youtube.com/watch?v=oGeEoaplMWA</a> <strong>DEF CON Safe Mode - Feng Xiao - Discovering Hidden Properties to Attack Node js Ecosystem</strong></li>
</ul>
<p><strong>Ariticle</strong></p>
<ul>
<li><a href="https://brightsec.com/blog/prototype-pollution/">https://brightsec.com/blog/prototype-pollution/</a></li>
<li><a href="https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html">https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html</a> æ¨è è®²çš„ä¸é”™</li>
<li><a href="https://infosecwriteups.com/javascript-prototype-pollution-practice-of-finding-and-exploitation-f97284333b2">https://infosecwriteups.com/javascript-prototype-pollution-practice-of-finding-and-exploitation-f97284333b2</a>  è¿™ä¸ªå†™çš„å¥½å¥½</li>
</ul>
<p><strong>Book</strong></p>
<ul>
<li>Prototype pollution attack in NodeJS application: <a href="https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/paper/JavaScript_prototype_pollution_attack_in_NodeJS.pdf">https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/paper/JavaScript_prototype_pollution_attack_in_NodeJS.pdf</a></li>
</ul>
<p><strong>Demo:</strong></p>
<ul>
<li>https://github.com/PwnFunction/Next.js-Flat-Prototype-Pollution</li>
</ul>
<p><strong>github:</strong></p>
<ul>
<li><a href="https://github.com/BlackFan/client-side-prototype-pollution">https://github.com/BlackFan/client-side-prototype-pollution</a></li>
</ul>

          </div>
        </div>

        
          <div class="next-post">
            <a class="purple-link" href="https://1dayluo.github.io/post/htbbackend-api/">
              <h3 class="post-title">
                ä¸‹ä¸€ç¯‡ï¼š[HTB]Backend - API
              </h3>
            </a>
          </div>
          
      </div>

      

      <div class="site-footer">
  <div class="slogan">ç¢æœˆæ˜Ÿè¾°æ½æ±Ÿé£ , æˆ‘å¿ƒæœ‰å‰‘é—®å¤©æ¶¯ </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
   | <a class="rss" href="https://1dayluo.github.io/atom.xml" target="_blank">RSS</a>
</div>


    </div>
    <script type="application/javascript">

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>




  </body>
</html>
